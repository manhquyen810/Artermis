import{a as ge,b as pe,c as fe}from"./chunk-RJFCCH4I.js";import"./chunk-RUZE5GXG.js";import{a as de}from"./chunk-7F5FYCZN.js";import{a as he}from"./chunk-7OWNIVQU.js";import"./chunk-3DNS47RB.js";import{a as xe}from"./chunk-UVXOAEFF.js";import{c as be}from"./chunk-4ISQXSLY.js";import"./chunk-5WJSNL65.js";import"./chunk-S5MKSB5U.js";import{a as ae}from"./chunk-U6AELCVK.js";import{a as re}from"./chunk-QGGSPP32.js";import"./chunk-FNJRUM5G.js";import{a as le}from"./chunk-LXDP326M.js";import{a as me}from"./chunk-4P7M5PJP.js";import"./chunk-V55WZ52P.js";import{a as ue}from"./chunk-GITU5WHL.js";import"./chunk-GXLYQKDJ.js";import{a as ce}from"./chunk-HPCUFM6M.js";import"./chunk-CCVWGTN5.js";import"./chunk-MD22LTSS.js";import{a as oe}from"./chunk-RKZRHQUL.js";import"./chunk-JCAGYDTX.js";import"./chunk-OI2L2OHD.js";import"./chunk-A2A6JFSH.js";import"./chunk-MD6Z63OB.js";import"./chunk-M2FHCXD3.js";import"./chunk-RGQYMQQL.js";import"./chunk-FLZTDUOG.js";import"./chunk-QU4DXSXD.js";import"./chunk-A3NV42OL.js";import"./chunk-656XE4CO.js";import"./chunk-O2WHE2S3.js";import"./chunk-U4DJRHYQ.js";import"./chunk-JRBFEQNN.js";import"./chunk-DIZEKHOC.js";import"./chunk-V7PDYRDZ.js";import"./chunk-EANMTTQG.js";import"./chunk-65Z25AP3.js";import"./chunk-5M3YV54C.js";import"./chunk-RYZEETVB.js";import"./chunk-VTF2OQPK.js";import"./chunk-BNRTXX46.js";import"./chunk-N4VVKRBU.js";import"./chunk-5AQXEKLE.js";import{a as E,b as w,j as I}from"./chunk-3JSWSN6W.js";import"./chunk-7XNS72RJ.js";import"./chunk-KYCCMZSV.js";import{k as se,l as ne}from"./chunk-DXTZ4GAW.js";import"./chunk-2UXGFGK3.js";import"./chunk-O4VJ5OXY.js";import"./chunk-BDII35IB.js";import"./chunk-LARBQRTJ.js";import"./chunk-OTNXTVPX.js";import"./chunk-Z2YUBN6N.js";import"./chunk-6EYB5QBP.js";import"./chunk-GERFCPB6.js";import"./chunk-T624HJJL.js";import"./chunk-HQTS6JOY.js";import"./chunk-HMZID6NQ.js";import"./chunk-O26CMRR4.js";import"./chunk-MP6UGYTC.js";import"./chunk-2QXIMOEO.js";import"./chunk-JHBUBEY6.js";import"./chunk-R2SUWIPY.js";import"./chunk-35PLMJNP.js";import"./chunk-4I367PEU.js";import"./chunk-QA7Y7QBM.js";import"./chunk-ZPITQMA6.js";import"./chunk-2CUFQLAH.js";import{b as ie,c as te}from"./chunk-DRMCDU75.js";import"./chunk-Z6NSEM73.js";import"./chunk-AR57MWOI.js";import"./chunk-A5PTZAPN.js";import"./chunk-AU6UEH3U.js";import"./chunk-FGAONQTL.js";import"./chunk-HQ6UGNQX.js";import"./chunk-ZLJ76G5I.js";import"./chunk-MLVGKM2P.js";import{d as J}from"./chunk-CK7FH6VF.js";import{c as Y,d as q}from"./chunk-PUNMJFMR.js";import"./chunk-R75LTV62.js";import{c as X}from"./chunk-5MVJAZRV.js";import"./chunk-XBLNBTXN.js";import"./chunk-G3JOQOSD.js";import"./chunk-G4I63THF.js";import"./chunk-PZ7IDTIM.js";import"./chunk-CT44YL7Q.js";import"./chunk-ZFM7LHJQ.js";import"./chunk-JNO6DNVW.js";import"./chunk-5YQ3ACZE.js";import"./chunk-EELXLOHY.js";import{K as N}from"./chunk-VZRSC3LP.js";import"./chunk-5SKDOIBQ.js";import"./chunk-WA5GEAJB.js";import"./chunk-VK7JPHFE.js";import"./chunk-BNDLMKXK.js";import"./chunk-BQNBT6PW.js";import"./chunk-5GXY5RYT.js";import{a as Z}from"./chunk-K3W6YFKH.js";import{c as K}from"./chunk-JXJXC4DZ.js";import{d as $}from"./chunk-EDXSOKK5.js";import{b as Q}from"./chunk-R5BZWVRQ.js";import{p as S}from"./chunk-DID2YGL7.js";import{c as G,k as H}from"./chunk-CXQURQM5.js";import"./chunk-S4QLGR2R.js";import{kb as U,y as z}from"./chunk-Z4VHWOB5.js";import"./chunk-XUCCGZJR.js";import"./chunk-HKBU2OOC.js";import"./chunk-5ZXXURLP.js";import"./chunk-NOBD5HSR.js";import{a as ee}from"./chunk-U54OSGNH.js";import{f as L,h as B,i as P}from"./chunk-M6Z6DKZQ.js";import"./chunk-3Y6745HG.js";import{c as W}from"./chunk-E2KBL4LX.js";import"./chunk-PZTBTDSR.js";import{i as j}from"./chunk-IOA4DPXY.js";import{Db as o,Dc as A,Ea as f,Ed as O,Ma as h,Mc as _,Na as g,Oc as a,Tb as V,Zb as b,dd as i,kc as p,ld as k,md as T,nd as y,qd as F,sc as u,x as R,xc as l,yc as d,yd as M,zc as r,zd as D}from"./chunk-5LC5EQRR.js";import{j as v}from"./chunk-3E746U5Y.js";var _e=()=>[];function Ae(t,m){t&1&&(i(0,`
            `),r(1,"div",4),i(2,`
        `))}function Ce(t,m){if(t&1&&(i(0,`
            `),l(1,"div",5),i(2,`
                `),r(3,"span",6),i(4,`
                `),l(5,"span",7),M(6,"artemisTranslate"),i(7,`
                    `),r(8,"fa-icon",8),i(9,`
                `),d(),i(10,`
            `),d(),i(11,`
        `)),t&2){let e=a(2);o(5),p("ngbTooltip",D(6,2,"artemisApp.modelingAssessmentEditor.generativeAIAssessmentInfo")),o(3),p("icon",e.faQuestionCircle)}}function Se(t,m){if(t&1&&(i(0,`
            `),l(1,"div",9),i(2,`
                `),r(3,"fa-icon",10),i(4,`
                `),r(5,"span",11),i(6,`
            `),d(),i(7,`
        `)),t&2){let e=a(2);o(3),p("icon",e.faCircleNotch)}}function Ee(t,m){if(t&1){let e=A();i(0,`
                `),l(1,"jhi-modeling-assessment",12),_("feedbackChanged",function(s){h(e);let c=a(2);return g(c.onFeedbackChanged(s))}),d(),i(2,`
            `)}if(t&2){let e=a(2);o(),p("diagramType",e.modelingExercise==null?null:e.modelingExercise.diagramType)("maxScore",(e.modelingExercise==null?null:e.modelingExercise.maxPoints)||0)("maxBonusPoints",(e.modelingExercise==null?null:e.modelingExercise.bonusPoints)||0)("totalScore",e.totalScore)("umlModel",e.model)("readOnly",e.readOnly)("resultFeedbacks",(e.result==null?null:e.result.feedbacks)||F(13,_e))("highlightedElements",e.highlightedElements)("explanation",(e.submission==null?null:e.submission.explanationText)||"")("highlightDifferences",e.highlightDifferences)("elementCounts",e.submission&&e.submission.similarElements)("resizeOptions",e.resizeOptions)("course",e.course)}}function ve(t,m){if(t&1&&(i(0,`
                `),r(1,"jhi-collapsable-assessment-instructions",13),i(2,`
            `)),t&2){let e=a(2);o(),p("readOnly",!1)("exercise",e.modelingExercise)("collapsed",!1)}}function ke(t,m){if(t&1){let e=A();i(0,`
                `),l(1,"jhi-unreferenced-feedback",14),y("feedbacksChange",function(s){h(e);let c=a(2);return T(c.unreferencedFeedback,s)||(c.unreferencedFeedback=s),g(s)}),_("feedbacksChange",function(){h(e);let s=a(2);return g(s.validateFeedback())})("onAcceptSuggestion",function(s){h(e);let c=a(2);return g(c.removeSuggestion(s))})("onDiscardSuggestion",function(s){h(e);let c=a(2);return g(c.removeSuggestion(s))}),d(),i(2,`
            `)}if(t&2){let e=a(2);o(),k("feedbacks",e.unreferencedFeedback),p("feedbackSuggestions",e.unreferencedFeedbackSuggestions)("readOnly",e.readOnly)("highlightDifferences",e.highlightDifferences)("resultId",e.result.id)}}function Te(t,m){t&1&&(i(0,`
                        `),l(1,"div",17),i(2,`
                            `),r(3,"div",18),i(4,`
                            `),r(5,"span",19),i(6,`
                        `),d(),i(7,`
                    `))}function ye(t,m){t&1&&(i(0,`
                        `),l(1,"div",17),i(2,`
                            `),r(3,"div",20),i(4,`
                            `),r(5,"span",21),i(6,`
                        `),d(),i(7,`
                    `))}function Fe(t,m){if(t&1&&(i(0,`
                `),l(1,"div",15),i(2,`
                    `),r(3,"h4",16),i(4,`
                    `),b(5,Te,8,0)(6,ye,8,0),d(),i(7,`
            `)),t&2){let e=a(2);o(5),u(e.hasAutomaticFeedback?5:-1),o(),u(e.highlightMissingFeedback?6:-1)}}function Me(t,m){if(t&1&&(i(0,`
        `),b(1,Ae,3,0)(2,Ce,12,4)(3,Se,8,1),l(4,"div",2),i(5,`
            `),b(6,Ee,3,14)(7,ve,3,3),d(),i(8,`
        `),l(9,"div",3),i(10,`
            `),b(11,ke,3,5)(12,Fe,8,2),d(),i(13,`
    `)),t&2){let e=a();o(),u(e.hasAutomaticFeedback&&e.isAssessor&&!(e.result!=null&&e.result.completionDate)&&!e.isFeedbackSuggestionsEnabled?1:-1),o(),u(e.hasAutomaticFeedback&&e.isAssessor&&!(e.result!=null&&e.result.completionDate)&&e.isFeedbackSuggestionsEnabled?2:-1),o(),u(e.isLoading&&e.isFeedbackSuggestionsEnabled?3:-1),o(3),u(e.submission?6:-1),o(),u(e.modelingExercise?7:-1),o(4),u(e.result&&e.result.id?11:-1),o(),u((e.hasAutomaticFeedback||e.highlightMissingFeedback)&&!(e.result!=null&&e.result.completionDate)?12:-1)}}function De(t,m){if(t&1&&(i(0,`
            `),l(1,"div",22),i(2,`
                `),r(3,"p",23),i(4,`
                `),l(5,"a",24),i(6,`
                    `),r(7,"span",25),i(8,`
                `),d(),i(9,`
            `),d(),i(10,`
        `)),t&2){let e=a(2);o(5),p("routerLink",e.exerciseDashboardLink)}}function we(t,m){if(t&1&&(i(0,`
        `),b(1,De,11,1)),t&2){let e=a();o(),u(e.loadingInitialSubmission?-1:1)}}function Ie(t,m){t&1&&(i(0,`
        `),r(1,"div",4),i(2,`
    `))}function Re(t,m){if(t&1&&(i(0,`
        `),l(1,"div",5),i(2,`
            `),r(3,"span",6),i(4,`
            `),l(5,"span",7),M(6,"artemisTranslate"),i(7,`
                `),r(8,"fa-icon",8),i(9,`
            `),d(),i(10,`
        `),d(),i(11,`
    `)),t&2){let e=a(2);o(5),p("ngbTooltip",D(6,2,"artemisApp.modelingAssessmentEditor.generativeAIAssessmentInfo")),o(3),p("icon",e.faQuestionCircle)}}function Ve(t,m){if(t&1&&(i(0,`
        `),l(1,"div",9),i(2,`
            `),r(3,"fa-icon",10),i(4,`
            `),r(5,"span",11),i(6,`
        `),d(),i(7,`
    `)),t&2){let e=a(2);o(3),p("icon",e.faCircleNotch)}}function Oe(t,m){if(t&1){let e=A();i(0,`
            `),l(1,"jhi-modeling-assessment",12),_("feedbackChanged",function(s){h(e);let c=a(2);return g(c.onFeedbackChanged(s))}),d(),i(2,`
        `)}if(t&2){let e=a(2);o(),p("diagramType",e.modelingExercise==null?null:e.modelingExercise.diagramType)("maxScore",(e.modelingExercise==null?null:e.modelingExercise.maxPoints)||0)("maxBonusPoints",(e.modelingExercise==null?null:e.modelingExercise.bonusPoints)||0)("totalScore",e.totalScore)("umlModel",e.model)("readOnly",e.readOnly)("resultFeedbacks",(e.result==null?null:e.result.feedbacks)||F(13,_e))("highlightedElements",e.highlightedElements)("explanation",(e.submission==null?null:e.submission.explanationText)||"")("highlightDifferences",e.highlightDifferences)("elementCounts",e.submission&&e.submission.similarElements)("resizeOptions",e.resizeOptions)("course",e.course)}}function je(t,m){if(t&1&&(i(0,`
            `),r(1,"jhi-collapsable-assessment-instructions",13),i(2,`
        `)),t&2){let e=a(2);o(),p("readOnly",!1)("exercise",e.modelingExercise)("collapsed",!1)}}function Le(t,m){if(t&1){let e=A();i(0,`
            `),l(1,"jhi-unreferenced-feedback",26),y("feedbacksChange",function(s){h(e);let c=a(2);return T(c.unreferencedFeedback,s)||(c.unreferencedFeedback=s),g(s)}),_("feedbacksChange",function(){h(e);let s=a(2);return g(s.validateFeedback())}),d(),i(2,`
        `)}if(t&2){let e=a(2);o(),k("feedbacks",e.unreferencedFeedback),p("readOnly",e.readOnly)("highlightDifferences",e.highlightDifferences)("resultId",e.result.id)}}function Be(t,m){t&1&&(i(0,`
                    `),l(1,"div",17),i(2,`
                        `),r(3,"div",18),i(4,`
                        `),r(5,"span",19),i(6,`
                    `),d(),i(7,`
                `))}function Pe(t,m){t&1&&(i(0,`
                    `),l(1,"div",17),i(2,`
                        `),r(3,"div",20),i(4,`
                        `),r(5,"span",21),i(6,`
                    `),d(),i(7,`
                `))}function Ne(t,m){if(t&1&&(i(0,`
            `),l(1,"div",15),i(2,`
                `),r(3,"h4",16),i(4,`
                `),b(5,Be,8,0)(6,Pe,8,0),d(),i(7,`
        `)),t&2){let e=a(2);o(5),u(e.hasAutomaticFeedback?5:-1),o(),u(e.highlightMissingFeedback?6:-1)}}function We(t,m){if(t&1&&(i(0,`
    `),b(1,Ie,3,0)(2,Re,12,4)(3,Ve,8,1),l(4,"div",2),i(5,`
        `),b(6,Oe,3,14)(7,je,3,3),d(),i(8,`
    `),l(9,"div",3),i(10,`
        `),b(11,Le,3,4)(12,Ne,8,2),d(),i(13,`
`)),t&2){let e=a();o(),u(e.hasAutomaticFeedback&&e.isAssessor&&!(e.result!=null&&e.result.completionDate)&&!e.isFeedbackSuggestionsEnabled?1:-1),o(),u(e.hasAutomaticFeedback&&e.isAssessor&&!(e.result!=null&&e.result.completionDate)&&e.isFeedbackSuggestionsEnabled?2:-1),o(),u(e.isLoading&&e.isFeedbackSuggestionsEnabled?3:-1),o(3),u(e.submission?6:-1),o(),u(e.modelingExercise?7:-1),o(4),u(e.result&&e.result.id?11:-1),o(),u((e.hasAutomaticFeedback||e.highlightMissingFeedback)&&!(e.result!=null&&e.result.completionDate)?12:-1)}}var vi=(()=>{class t{alertService=f(K);router=f(B);route=f(L);modelingSubmissionService=f(le);modelingAssessmentService=f(me);accountService=f(Q);location=f(j);translateService=f(W);complaintService=f(re);structuredGradingCriterionService=f(ue);submissionService=f(J);exampleSubmissionService=f(xe);athenaService=f(ce);totalScore=0;submission;model;modelingExercise;course;result;referencedFeedback=[];unreferencedFeedback=[];automaticFeedback=[];feedbackSuggestions=[];highlightedElements;highlightMissingFeedback=!1;assessmentsAreValid=!1;nextSubmissionBusy;courseId;examId=0;exerciseId;exerciseGroupId;exerciseDashboardLink;userId;isAssessor=!1;complaint;ComplaintType=ae;isLoading=!0;isTestRun=!1;hasAutomaticFeedback=!1;hasAssessmentDueDatePassed;correctionRound=0;resultId;loadingInitialSubmission=!0;highlightDifferences=!1;resizeOptions={verticalResize:!0};isApollonModelLoaded=!1;cancelConfirmationText;faCircleNotch=z;faQuestionCircle=U;constructor(){this.translateService.get("artemisApp.modelingAssessmentEditor.messages.confirmCancel").subscribe(n=>this.cancelConfirmationText=n)}get feedback(){return[...this.referencedFeedback,...this.unreferencedFeedback]}get unreferencedFeedbackSuggestions(){return this.feedbackSuggestions.filter(e=>!e.reference)}get isFeedbackSuggestionsEnabled(){return!!this.modelingExercise?.feedbackSuggestionModule}ngOnInit(){this.accountService.identity().then(e=>{this.userId=e.id}),this.route.queryParamMap.subscribe(e=>{this.isTestRun=e.get("testRun")==="true",this.correctionRound=Number(e.get("correction-round"))}),this.route.paramMap.subscribe(e=>{this.courseId=Number(e.get("courseId")),this.exerciseId=Number(e.get("exerciseId")),e.has("examId")&&(this.examId=Number(e.get("examId")),this.exerciseGroupId=Number(e.get("exerciseGroupId"))),this.exerciseDashboardLink=te(this.courseId,this.exerciseId,this.examId,this.isTestRun);let n=e.get("submissionId");this.resultId=Number(e.get("resultId"))||0,n==="new"?this.loadRandomSubmission(this.exerciseId):this.loadSubmission(Number(n))})}loadFeedbackSuggestions(e,n){return v(this,null,function*(){try{return(yield R(this.athenaService.getModelingFeedbackSuggestions(e,n)))??[]}catch{return this.alertService.error("artemisApp.modelingAssessmentEditor.messages.loadFeedbackSuggestionsFailed"),[]}})}loadSubmission(e){this.modelingSubmissionService.getSubmission(e,this.correctionRound,this.resultId).subscribe({next:n=>{this.handleReceivedSubmission(n),this.validateFeedback()},error:n=>{this.handleErrorResponse(n)}})}loadRandomSubmission(e){this.modelingSubmissionService.getSubmissionWithoutAssessment(e,!0,this.correctionRound).subscribe({next:n=>v(this,null,function*(){if(!n){this.submission=void 0;return}yield this.handleReceivedSubmission(n),this.validateFeedback();let s=window.location.hash.replace("#","").replace("new",`${this.submission.id}`);this.location.go(s)}),error:n=>{this.handleErrorResponse(n)}})}handleReceivedSubmission(e){return v(this,null,function*(){this.loadingInitialSubmission=!1,this.submission=e;let n=this.submission.participation;this.modelingExercise=n.exercise,this.course=H(this.modelingExercise),this.resultId>0?(this.result=q(e,this.resultId),this.correctionRound=e.results?.findIndex(s=>s.id===this.resultId)):this.result=Y(this.submission,this.correctionRound),this.hasAssessmentDueDatePassed=!!this.modelingExercise?.assessmentDueDate&&S(this.modelingExercise.assessmentDueDate).isBefore(S()),this.submission.model?this.model=JSON.parse(this.submission.model):(this.alertService.closeAll(),this.alertService.warning("artemisApp.modelingAssessmentEditor.messages.noModel")),this.checkPermissions(),this.getComplaint(),this.result&&this.submission?.participation&&(this.submission.participation.results=[this.result],this.result.participation=this.submission.participation),this.modelingExercise.diagramType||(this.modelingExercise.diagramType=oe.ClassDiagram),this.result?.feedbacks?this.result=this.modelingAssessmentService.convertResult(this.result):this.result&&(this.result.feedbacks=[]),this.modelingExercise.feedbackSuggestionModule&&(this.result?.feedbacks?.length??0)===this.automaticFeedback.length&&(this.feedbackSuggestions=yield this.loadFeedbackSuggestions(this.modelingExercise,this.submission),this.result&&(this.result.feedbacks=[...this.result?.feedbacks||[],...this.feedbackSuggestions.filter(s=>!!s.reference)])),this.handleFeedback(this.result?.feedbacks),(!this.result?.assessor||this.result.assessor.id===this.userId)&&!this.result?.completionDate&&(this.alertService.closeAll(),this.alertService.info("artemisApp.modelingAssessmentEditor.messages.lock")),this.submissionService.handleFeedbackCorrectionRoundTag(this.correctionRound,this.submission),this.isLoading=!1})}updateApollonEditorWithFeedback(e){this.referencedFeedback=e.filter(n=>n.reference),this.isApollonModelLoaded||(this.isApollonModelLoaded=!0,this.calculateTotalScore(),this.submissionService.handleFeedbackCorrectionRoundTag(this.correctionRound,this.submission)),this.validateFeedback()}getComplaint(){this.submission&&this.complaintService.findBySubmissionId(this.submission.id).subscribe({next:e=>{e.body&&(this.complaint=e.body)},error:()=>{this.onError()}})}handleFeedback(e){!e||e.length===0||(this.referencedFeedback=e.filter(n=>n.reference),this.unreferencedFeedback=e.filter(n=>!n.reference),this.hasAutomaticFeedback=e.some(n=>n.type===w.AUTOMATIC),this.highlightAutomaticFeedback(),this.highlightMissingFeedback&&this.highlightElementsWithMissingFeedback(),this.calculateTotalScore())}checkPermissions(){this.isAssessor=this.result?.assessor?.id===this.userId}get canOverride(){if(this.modelingExercise){if(this.modelingExercise.isAtLeastInstructor)return!0;if(this.complaint&&this.isAssessor)return!1;let e=!0;return this.modelingExercise.assessmentDueDate&&(e=S().isBefore(this.modelingExercise.assessmentDueDate)),this.isAssessor&&e}return!1}removeSuggestion(e){this.feedbackSuggestions=this.feedbackSuggestions.filter(n=>n!==e)}get readOnly(){return!pe(this.isTestRun,this.isAssessor,this.hasAssessmentDueDatePassed,this.result,this.complaint,this.modelingExercise)}handleErrorResponse(e){this.loadingInitialSubmission=!1,this.submission=void 0,this.isLoading=!1,e.error&&e.error.errorKey==="lockedSubmissionsLimitReached"?this.navigateBack():this.onError()}onError(){this.submission=void 0,this.modelingExercise=void 0,this.result=void 0,this.model=void 0,this.alertService.closeAll(),this.alertService.error("artemisApp.modelingAssessmentEditor.messages.loadSubmissionFailed")}onSaveAssessment(){if(!this.modelingAssessmentService.isFeedbackTextValid(this.feedback)){this.alertService.error("artemisApp.modelingAssessmentEditor.messages.feedbackTextTooLong");return}this.modelingAssessmentService.saveAssessment(this.result.id,this.feedback,this.submission.id,this.result.assessmentNote?.note).subscribe({next:e=>{this.result=e,this.handleFeedback(this.result.feedbacks),this.alertService.closeAll(),this.alertService.success("artemisApp.modelingAssessmentEditor.messages.saveSuccessful")},error:()=>{this.alertService.closeAll(),this.alertService.error("artemisApp.modelingAssessmentEditor.messages.saveFailed")}})}onSubmitAssessment(){if(this.model&&this.referencedFeedback.length<Object.keys(this.model.elements).length||!this.assessmentsAreValid){let e=this.translateService.instant("artemisApp.modelingAssessmentEditor.messages.confirmSubmission");this.modelingExercise?.assessmentDueDate&&S().isBefore(this.modelingExercise.assessmentDueDate)?this.submitAssessment():window.confirm(e)?this.submitAssessment():(this.highlightMissingFeedback=!0,this.highlightElementsWithMissingFeedback())}else this.submitAssessment()}submitAssessment(){if(!this.modelingAssessmentService.isFeedbackTextValid(this.feedback)){this.alertService.error("artemisApp.modelingAssessmentEditor.messages.feedbackTextTooLong");return}this.modelingAssessmentService.saveAssessment(this.result.id,this.feedback,this.submission.id,this.result.assessmentNote?.note,!0).subscribe({next:e=>{e.participation.results=[e],this.result=e,this.alertService.closeAll(),this.alertService.success("artemisApp.modelingAssessmentEditor.messages.submitSuccessful"),this.highlightMissingFeedback=!1},error:e=>{let n="artemisApp.modelingAssessmentEditor.messages.submitFailed";e.error&&e.error.entityName&&e.error.message&&(n=`artemisApp.${e.error.entityName}.${e.error.message}`),this.alertService.closeAll(),this.alertService.error(n)}})}onUpdateAssessmentAfterComplaint(e){if(this.validateFeedback(),!this.assessmentsAreValid){this.alertService.error("artemisApp.modelingAssessment.invalidAssessments"),e.onError();return}this.modelingAssessmentService.updateAssessmentAfterComplaint(this.feedback,e.complaintResponse,this.submission.id,this.result?.assessmentNote?.note).subscribe({next:n=>{e.onSuccess(),this.result=n.body,this.result.participation.results=[this.result],this.alertService.closeAll(),this.alertService.success("artemisApp.modelingAssessmentEditor.messages.updateAfterComplaintSuccessful")},error:n=>{e.onError(),this.alertService.closeAll();let s=n.error;s&&s.errorKey&&s.errorKey==="complaintLock"?this.alertService.error(s.message,s.params):this.alertService.error("artemisApp.modelingAssessmentEditor.messages.updateAfterComplaintFailed")}})}onCancelAssessment(){window.confirm(this.cancelConfirmationText)&&this.modelingAssessmentService.cancelAssessment(this.submission.id).subscribe(()=>{this.navigateBack()})}onFeedbackChanged(e){this.updateApollonEditorWithFeedback(e)}assessNext(){this.isLoading=!0,this.nextSubmissionBusy=!0,this.modelingSubmissionService.getSubmissionWithoutAssessment(this.modelingExercise.id,!0,this.correctionRound).subscribe({next:e=>{if(!e){this.submission=void 0;return}this.nextSubmissionBusy=!1,this.isLoading=!1;let n=ie(G.MODELING,this.courseId,this.exerciseId,void 0,e.id,this.examId,this.exerciseGroupId);this.router.navigateByUrl("/",{skipLocationChange:!0}).then(()=>this.router.navigate(n,{queryParams:{"correction-round":this.correctionRound}}))},error:e=>{this.nextSubmissionBusy=!1,this.handleErrorResponse(e)}})}validateFeedback(){this.calculateTotalScore();let e=I.haveCredits(this.referencedFeedback),n=I.haveCreditsAndComments(this.unreferencedFeedback);this.assessmentsAreValid=e&&this.unreferencedFeedback.length===0||n,this.submissionService.handleFeedbackCorrectionRoundTag(this.correctionRound,this.submission)}navigateBack(){ge(this.location,this.router,this.modelingExercise,this.submission,this.isTestRun)}highlightElementsWithMissingFeedback(){if(!this.model)return;this.highlightedElements=this.highlightedElements?this.removeHighlightedFeedbackOfColor(this.highlightedElements,E.RED):new Map;let e=this.referencedFeedback.map(n=>n.referenceId);for(let n of Object.values(this.model.elements))e.includes(n.id)||this.highlightedElements.set(n.id,E.RED)}highlightAutomaticFeedback(){if(!(this.result&&this.result.completionDate)){this.highlightedElements=this.highlightedElements?this.removeHighlightedFeedbackOfColor(this.highlightedElements,E.CYAN):new Map;for(let e of this.referencedFeedback)e.type===w.AUTOMATIC&&e.referenceId&&this.highlightedElements.set(e.referenceId,E.CYAN)}}removeHighlightedFeedbackOfColor(e,n){return new Map([...e].filter(([,s])=>s!==n))}calculateTotalScore(){let e=ne(this.modelingExercise),n=this.structuredGradingCriterionService.computeTotalScore(this.feedback);this.totalScore=se(n,e)}useStudentSubmissionAsExampleSubmission(){this.submission&&this.modelingExercise&&this.exampleSubmissionService.import(this.submission.id,this.modelingExercise.id).subscribe({next:()=>this.alertService.success("artemisApp.exampleSubmission.submitSuccessful"),error:e=>X(this.alertService,e)})}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=V({type:t,selectors:[["jhi-modeling-assessment-editor"]],decls:8,vars:16,consts:[["assessment",""],[3,"navigateBack","save","onSubmit","onCancel","nextSubmission","updateAssessmentAfterComplaint","highlightDifferencesChange","useAsExampleSubmission","isLoading","nextSubmissionBusy","isTeamMode","isAssessor","isTestRun","exerciseDashboardLink","canOverride","result","assessmentsAreValid","complaint","exercise","submission","hasAssessmentDueDatePassed","highlightDifferences","correctionRound"],[1,"editor-container","flex-grow-1"],[1,"row","mt-3"],["jhiTranslate","artemisApp.modelingAssessmentEditor.automaticAssessmentAvailable",1,"alert","alert-info"],[1,"alert","alert-info"],["jhiTranslate","artemisApp.modelingAssessmentEditor.generativeAIAssessmentAvailable"],["tooltipClass","tooltip-wide",2,"float","right",3,"ngbTooltip"],["size","lg",3,"icon"],[1,"alert"],["size","lg","animation","spin",1,"me-2",3,"icon"],["jhiTranslate","artemisApp.modelingAssessmentEditor.automaticAssessmentLoading"],[3,"feedbackChanged","diagramType","maxScore","maxBonusPoints","totalScore","umlModel","readOnly","resultFeedbacks","highlightedElements","explanation","highlightDifferences","elementCounts","resizeOptions","course"],[3,"readOnly","exercise","collapsed"],[3,"feedbacksChange","onAcceptSuggestion","onDiscardSuggestion","feedbacks","feedbackSuggestions","readOnly","highlightDifferences","resultId"],[1,"col-md-6"],["jhiTranslate","artemisApp.modelingAssessmentEditor.highlightingColors.title"],[1,"row"],[1,"mx-3","mb-2","highlighting-item","color-cyan"],["jhiTranslate","artemisApp.modelingAssessmentEditor.highlightingColors.automaticAssessment"],[1,"mx-3","mb-2","highlighting-item","color-red"],["jhiTranslate","artemisApp.modelingAssessmentEditor.highlightingColors.missingAssessment"],["role","alert",1,"alert","alert-warning","text-center","mt-4"],["jhiTranslate","artemisApp.modelingAssessment.notFound"],[1,"btn","btn-info","btn-sm","me-1","mb-1","assessment-dashboard",3,"routerLink"],["jhiTranslate","entity.action.exerciseDashboard",1,"d-none","d-md-inline"],[3,"feedbacksChange","feedbacks","readOnly","highlightDifferences","resultId"]],template:function(n,s){if(n&1){let c=A();l(0,"jhi-assessment-layout",1),_("navigateBack",function(){return h(c),g(s.navigateBack())})("save",function(){return h(c),g(s.onSaveAssessment())})("onSubmit",function(){return h(c),g(s.onSubmitAssessment())})("onCancel",function(){return h(c),g(s.onCancelAssessment())})("nextSubmission",function(){return h(c),g(s.assessNext())})("updateAssessmentAfterComplaint",function(C){return h(c),g(s.onUpdateAssessmentAfterComplaint(C))}),y("highlightDifferencesChange",function(C){return h(c),T(s.highlightDifferences,C)||(s.highlightDifferences=C),g(C)}),_("useAsExampleSubmission",function(){return h(c),g(s.useStudentSubmissionAsExampleSubmission())}),i(1,`
    `),b(2,Me,14,7)(3,we,2,1),d(),i(4,`
`),b(5,We,14,7,"ng-template",null,0,O),i(7,`
`)}n&2&&(p("isLoading",s.isLoading)("nextSubmissionBusy",s.nextSubmissionBusy)("isTeamMode",!!(s.modelingExercise!=null&&s.modelingExercise.teamMode))("isAssessor",s.isAssessor)("isTestRun",s.isTestRun)("exerciseDashboardLink",s.exerciseDashboardLink)("canOverride",s.canOverride)("result",s.result)("assessmentsAreValid",s.assessmentsAreValid)("complaint",s.complaint)("exercise",s.modelingExercise)("submission",s.submission)("hasAssessmentDueDatePassed",s.hasAssessmentDueDatePassed),k("highlightDifferences",s.highlightDifferences),p("correctionRound",s.correctionRound),o(2),u(s.submission?2:3))},dependencies:[fe,ee,N,$,be,de,he,P,Z],styles:[".editor-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;width:100%;height:100%;min-height:700px}.editor-container[_ngcontent-%COMP%]   jhi-modeling-assessment[_ngcontent-%COMP%]{min-width:0;width:100%}.highlighting-item[_ngcontent-%COMP%]{width:100px;height:25px}.color-red[_ngcontent-%COMP%]{background-color:#db3545cc}.color-cyan[_ngcontent-%COMP%]{background-color:#17a2b880}.text-editor-textarea[_ngcontent-%COMP%]{width:100%;height:200px;padding:10px 12px;border:1px solid var(--text-editor-border-color);border-radius:2px;background-color:var(--text-editor-background);color:var(--text-editor-color);resize:none;margin:0 15px}.feedback-suggestions-loading-indicator[_ngcontent-%COMP%]{padding-top:10px;padding-bottom:10px}"]})}return t})();export{vi as ModelingAssessmentEditorComponent};
//# sourceMappingURL=modeling-assessment-editor.component-KAPLH3OB.js.map

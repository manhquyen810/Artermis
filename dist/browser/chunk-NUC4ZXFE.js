import{a as Q}from"./chunk-FLFES4R7.js";import{a as G}from"./chunk-JHBUBEY6.js";import{a as $}from"./chunk-AZBLKUAM.js";import{c as O,e as W}from"./chunk-CK7FH6VF.js";import{a as E}from"./chunk-PZ7IDTIM.js";import{l as J}from"./chunk-CT44YL7Q.js";import{K as B,L as P,v as M}from"./chunk-VZRSC3LP.js";import{t as D}from"./chunk-VK7JPHFE.js";import{c as N}from"./chunk-BNDLMKXK.js";import{a as H}from"./chunk-K3W6YFKH.js";import{c as j}from"./chunk-JXJXC4DZ.js";import{d as K,f as X}from"./chunk-EDXSOKK5.js";import{b as I}from"./chunk-R5BZWVRQ.js";import{c as T}from"./chunk-CXQURQM5.js";import{Ac as V}from"./chunk-Z4VHWOB5.js";import{a as z}from"./chunk-U54OSGNH.js";import{c as w}from"./chunk-E2KBL4LX.js";import{Db as r,Dc as k,Ea as a,Ed as U,L as q,Ma as u,Mc as x,Na as d,Oc as l,Tb as y,Ya as L,Za as m,Zb as g,cd as F,dd as t,gd as v,kc as b,ma as R,mc as f,sc as C,xc as o,yc as c,yd as S,zc as p,zd as A}from"./chunk-5LC5EQRR.js";function Y(i,_){if(i&1){let e=k();t(0,`
            `),o(1,"button",1),S(2,"artemisTranslate"),x("click",function(){u(e);let n=l(3),h=F(2);return d(n.requestAIFeedback(h))}),t(3,`
                `),p(4,"fa-icon",2),t(5,`
                `),p(6,"span",3),t(7,`
                `),o(8,"span",4),t(9),c(),t(10,`
            `),c(),t(11,`
        `)}if(i&2){let e=l(3);r(),f("btn-sm",e.smallButtons()),b("disabled",!e.isSubmitted()||e.isGeneratingFeedback())("id","request-feedback-"+e.exercise().id)("ngbTooltip",A(2,13,"artemisApp.exerciseActions.requestAutomaticFeedbackTooltip")),r(3),b("icon",e.faPenSquare)("fixedWidth",!0),r(4),f("bg-warning",e.currentFeedbackRequestCount<e.feedbackRequestLimit)("bg-danger",e.currentFeedbackRequestCount>=e.feedbackRequestLimit),r(),v(`
                    `,e.currentFeedbackRequestCount," / ",e.feedbackRequestLimit,`
                `)}}function Z(i,_){if(i&1){let e=k();t(0,`
            `),o(1,"button",5),S(2,"artemisTranslate"),x("click",function(){u(e);let n=l(3),h=F(2);return d(n.requestAIFeedback(h))}),t(3,`
                `),p(4,"fa-icon",2),t(5,`
                `),p(6,"span",3),t(7,`
                `),o(8,"span",4),t(9),c(),t(10,`
            `),c(),t(11,`
        `)}if(i&2){let e=l(3);r(),f("btn-sm",e.smallButtons()),b("id","request-feedback-"+e.exercise().id)("ngbTooltip",A(2,12,"artemisApp.exerciseActions.requestAutomaticFeedbackTooltip")),r(3),b("icon",e.faPenSquare)("fixedWidth",!0),r(4),f("bg-warning",e.currentFeedbackRequestCount<e.feedbackRequestLimit)("bg-danger",e.currentFeedbackRequestCount>=e.feedbackRequestLimit),r(),v(`
                    `,e.currentFeedbackRequestCount," / ",e.feedbackRequestLimit,`
                `)}}function ee(i,_){if(i&1&&(t(0,`
        `),g(1,Y,12,15)(2,Z,12,14)),i&2){let e=l(2);r(),C(e.exercise().type===e.ExerciseType.TEXT||e.exercise().type===e.ExerciseType.MODELING?1:2)}}function te(i,_){if(i&1){let e=k();t(0,`
        `),o(1,"a",5),S(2,"artemisTranslate"),x("click",function(){u(e);let n=l(2);return d(n.requestFeedback())}),t(3,`
            `),p(4,"fa-icon",2),t(5,`
            `),p(6,"span",6),t(7,`
        `),c(),t(8,`
    `)}if(i&2){let e=l(2);r(),f("btn-sm",e.smallButtons()),b("id","request-feedback-"+e.exercise().id)("ngbTooltip",A(2,6,"artemisApp.exerciseActions.requestManualFeedbackTooltip")),r(3),b("icon",e.faPenSquare)("fixedWidth",!0)}}function ie(i,_){if(i&1&&(t(0,`
    `),g(1,ee,3,1)(2,te,9,8)),i&2){let e=l();r(),C(e.athenaEnabled?1:2)}}function ne(i,_){if(i&1){let e=k();t(0,`
    `),o(1,"div",7),t(2,`
        `),p(3,"h4",8),t(4,`
        `),o(5,"button",9),x("click",function(){let n=u(e).$implicit;return d(n.dismiss("Cross click"))}),c(),t(6,`
    `),c(),t(7,`
    `),p(8,"div",10),t(9,`
    `),o(10,"div",11),t(11,`
        `),o(12,"button",12),x("click",function(){let n=u(e).$implicit;return d(n.dismiss("decline"))}),c(),t(13,`
        `),o(14,"button",13),x("click",function(){let n=u(e).$implicit,h=l();return d(h.acceptExternalLLMUsage(n))}),c(),t(15,`
    `),c(),t(16,`
`)}}var Re=(()=>{class i{faPenSquare=V;athenaEnabled=!1;requestFeedbackEnabled=!1;isExamExercise;participation;hasUserAcceptedExternalLLMUsage;currentFeedbackRequestCount=0;feedbackRequestLimit=10;isSubmitted=m();pendingChanges=m(!1);hasAthenaResultForLatestSubmission=m(!1);isGeneratingFeedback=m();smallButtons=m(!1);exercise=m.required();generatingFeedback=L();profileService=a(N);alertService=a(j);courseExerciseService=a(Q);translateService=a(w);exerciseService=a(O);participationService=a(W);accountService=a(I);userService=a($);modalService=a(M);participationWebsocketService=a(G);athenaResultUpdateListener;acceptSubscription;ExerciseType=T;ngOnInit(){this.profileService.getProfileInfo().subscribe(e=>{this.athenaEnabled=e.activeProfiles?.includes(D)}),this.isExamExercise=J(this.exercise()),!(this.isExamExercise||!this.exercise().id)&&(this.requestFeedbackEnabled=this.exercise().allowFeedbackRequests??!1,this.updateParticipation(),this.setUserAcceptedExternalLLMUsage())}ngOnDestroy(){this.athenaResultUpdateListener?.unsubscribe(),this.acceptSubscription?.unsubscribe()}updateParticipation(){this.exercise().id&&this.exerciseService.getExerciseDetails(this.exercise().id).subscribe({next:e=>{this.participation=this.participationService.getSpecificStudentParticipation(e.body.exercise.studentParticipations??[],!1),this.participation&&(this.currentFeedbackRequestCount=this.participation.results?.filter(s=>s.assessmentType==E.AUTOMATIC_ATHENA&&s.successful==!0).length??0,this.subscribeToResultUpdates())},error:e=>{this.alertService.error(`artemisApp.${e.error.entityName}.errors.${e.error.errorKey}`)}})}setUserAcceptedExternalLLMUsage(){this.hasUserAcceptedExternalLLMUsage=!!this.accountService.userIdentity?.externalLLMUsageAccepted}acceptExternalLLMUsage(e){this.acceptSubscription?.unsubscribe(),this.acceptSubscription=this.userService.acceptExternalLLMUsage().subscribe(()=>{this.hasUserAcceptedExternalLLMUsage=!0,this.accountService.setUserAcceptedExternalLLMUsage(),e.close()}),this.assureConditionsSatisfied()&&this.processFeedbackRequest()}requestAIFeedback(e){if(!this.hasUserAcceptedExternalLLMUsage){this.modalService.open(e,{ariaLabelledBy:"modal-title"});return}this.requestFeedback()}subscribeToResultUpdates(){this.participation?.id&&(this.athenaResultUpdateListener=this.participationWebsocketService.subscribeForLatestResultOfParticipation(this.participation.id,!0).pipe(R(1),q(e=>!!e),q(e=>e.assessmentType===E.AUTOMATIC_ATHENA)).subscribe(this.handleAthenaAssessment.bind(this)))}handleAthenaAssessment(e){e.completionDate&&e.successful&&(this.currentFeedbackRequestCount+=1)}requestFeedback(){this.assureConditionsSatisfied()&&this.processFeedbackRequest()}processFeedbackRequest(){this.courseExerciseService.requestFeedback(this.exercise().id).subscribe({next:e=>{e&&(this.generatingFeedback.emit(),this.alertService.success("artemisApp.exercise.feedbackRequestSent"))},error:e=>{this.alertService.error(`artemisApp.exercise.${e.error.errorKey}`)}})}assureConditionsSatisfied(){return this.exercise().type===T.PROGRAMMING||this.assureTextModelingConditions()}assureTextModelingConditions(){if(this.hasAthenaResultForLatestSubmission()){let e=this.translateService.instant("artemisApp.exercise.submissionAlreadyHasAthenaResult");return this.alertService.warning(e),!1}if(this.pendingChanges()){let e=this.translateService.instant("artemisApp.exercise.feedbackRequestPendingChanges");return this.alertService.warning(e),!1}return!0}static \u0275fac=function(s){return new(s||i)};static \u0275cmp=y({type:i,selectors:[["jhi-request-feedback-button"]],inputs:{isSubmitted:[1,"isSubmitted"],pendingChanges:[1,"pendingChanges"],hasAthenaResultForLatestSubmission:[1,"hasAthenaResultForLatestSubmission"],isGeneratingFeedback:[1,"isGeneratingFeedback"],smallButtons:[1,"smallButtons"],exercise:[1,"exercise"]},outputs:{generatingFeedback:"generatingFeedback"},decls:4,vars:1,consts:[["popup",""],[1,"btn","btn-primary",3,"click","disabled","id","ngbTooltip"],[3,"icon","fixedWidth"],["jhiTranslate","artemisApp.exerciseActions.requestAutomaticFeedback",1,"d-none","d-md-inline"],[1,"badge"],[1,"btn","btn-primary",3,"click","id","ngbTooltip"],["jhiTranslate","artemisApp.exerciseActions.requestManualFeedback",1,"d-none","d-md-inline"],[1,"modal-header"],["id","modal-title","jhiTranslate","artemisApp.exerciseActions.externalLLMUsage.popUpLabel",1,"modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],["jhiTranslate","artemisApp.exerciseActions.externalLLMUsage.popUpMessage",1,"modal-body"],[1,"modal-footer"],["type","button","jhiTranslate","artemisApp.exerciseActions.externalLLMUsage.decline",1,"btn","btn-outline-secondary",3,"click"],["type","button","jhiTranslate","artemisApp.exerciseActions.externalLLMUsage.accept",1,"btn","btn-primary",3,"click"]],template:function(s,n){s&1&&(g(0,ie,3,1)(1,ne,17,0,"ng-template",null,0,U),t(3,`
`)),s&2&&C(!n.isExamExercise&&n.requestFeedbackEnabled?0:-1)},dependencies:[P,B,X,K,H,z],encapsulation:2})}return i})();export{Re as a};
//# sourceMappingURL=chunk-NUC4ZXFE.js.map

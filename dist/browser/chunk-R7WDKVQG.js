import{b as g,c as S}from"./chunk-7WZTW6CZ.js";import{a as y}from"./chunk-GRLLGFUW.js";import{f as h}from"./chunk-CT44YL7Q.js";import{L as p,O as B}from"./chunk-IOA4DPXY.js";import{Ea as l,ya as P}from"./chunk-5LC5EQRR.js";import{a as G,b as m}from"./chunk-3E746U5Y.js";var V=(()=>{class a{http=l(B);gradingSystemService=l(y);resourceUrl="api/assessment";deleteBonus(e,t,r){return this.http.delete(`${this.resourceUrl}/courses/${e}/exams/${t}/bonus/${r}`,{observe:"response"})}createBonusForExam(e,t,r){return this.http.post(`${this.resourceUrl}/courses/${e}/exams/${t}/bonus`,this.filterBonusForRequest(r),{observe:"response"})}updateBonus(e,t,r){return this.http.put(`${this.resourceUrl}/courses/${e}/exams/${t}/bonus/${r.id}`,this.filterBonusForRequest(r),{observe:"response"})}findBonusForExam(e,t,r){let i=r!=null?new p().set("includeSourceGradeSteps",r.toString()):void 0;return this.http.get(`${this.resourceUrl}/courses/${e}/exams/${t}/bonus`,{observe:"response",params:i})}generateBonusExamples(e,t){if(!e.sourceGradingScale)throw new Error(`Bonus.sourceGradingScale is empty: ${e.sourceGradingScale}`);let r=this.generateExampleExamAndBonusPoints(t,e.sourceGradingScale);return r.forEach(i=>this.calculateFinalGrade(i,e,t)),r}filterBonusForRequest(e){return m(G({},e),{sourceGradingScale:e.sourceGradingScale?{id:e.sourceGradingScale.id}:void 0,bonusToGradingScale:void 0})}generateExampleExamAndBonusPoints(e,t){let r=[];r.push(new S(0,void 0));let i=e.gradeSteps.findIndex(d=>d.isPassingGrade);if(i<0)throw Error("No passing grade was found for bonusTo grading scale");let s=t.gradeSteps.length-1,n=this.gradingSystemService.getGradingScaleMaxPoints(t);for(let d=0;d<3;d++){let f=e.gradeSteps[i],w=this.getIncludedBoundaryPoints(f,e.maxPoints)??this.findMiddlePoint(f),u=t.gradeSteps[s],M=this.getIncludedBoundaryPoints(u,n)??this.findMiddlePoint(u);r.push(new S(w,M)),d===0&&u.lowerBoundPoints===n&&!u.lowerBoundInclusive&&(s=this.modulo(s-1,t.gradeSteps.length)),s=this.modulo(s-1,t.gradeSteps.length),i=this.modulo(i+1,e.gradeSteps.length)}i=e.gradeSteps.length-1;let o=e.gradeSteps[i],x=this.getIncludedBoundaryPoints(o,e.maxPoints)??this.findMiddlePoint(o),c=t.gradeSteps[s];this.gradingSystemService.getNumericValueForGradeName(c.gradeName)===0&&(c=t.gradeSteps[t.gradeSteps.length-1]);let v=this.getIncludedBoundaryPoints(c,n)??this.findMiddlePoint(c);return r.push(new S(x,v)),r}findMiddlePoint(e){return((e.lowerBoundPoints??0)+(e.upperBoundPoints??0))/2}calculateFinalGrade(e,t,r){let i=this.gradingSystemService.findMatchingGradeStepByPoints(r.gradeSteps,e.studentPointsOfBonusTo,r.maxPoints);if(e.examGrade=i?.gradeName,!i?.isPassingGrade||!t.sourceGradingScale){e.bonusGrade=0,e.finalPoints=e.studentPointsOfBonusTo,e.finalGrade=e.examGrade;return}let s=this.gradingSystemService.findMatchingGradeStepByPoints(t.sourceGradingScale.gradeSteps,e.studentPointsOfBonusSource??0,this.gradingSystemService.getGradingScaleMaxPoints(t.sourceGradingScale));e.bonusGrade=this.gradingSystemService.getNumericValueForGradeName(s?.gradeName),this.calculateBonusForStrategy(e,t,r)}calculateBonusForStrategy(e,t,r){let i=this.gradingSystemService.getGradingScaleCourse(t.bonusToGradingScale);switch(t.bonusStrategy){case g.POINTS:{e.finalPoints=h(e.studentPointsOfBonusTo+(t.weight??1)*e.bonusGrade,i),e.exceedsMax=this.doesBonusExceedMax(e.finalPoints,r.maxPoints,t.weight),e.exceedsMax&&(e.finalPoints=r.maxPoints??0);let s=this.gradingSystemService.findMatchingGradeStepByPoints(r.gradeSteps,e.finalPoints,r.maxPoints);e.finalGrade=s?.gradeName;break}case g.GRADES_CONTINUOUS:{let s=this.gradingSystemService.getNumericValueForGradeName(e.examGrade);e.finalGrade=h(s+(t.weight??1)*e.bonusGrade,i);let n=this.gradingSystemService.maxGrade(r.gradeSteps),o=this.gradingSystemService.getNumericValueForGradeName(n);e.exceedsMax=this.doesBonusExceedMax(e.finalGrade,o,t.weight),e.exceedsMax&&(e.finalGrade=n);break}case g.GRADES_DISCRETE:throw new Error("GRADES_DISCRETE bonus strategy not yet implemented")}}doesBonusExceedMax(e,t,r){return(e-t)*r>0}getIncludedBoundaryPoints(e,t){if(e.lowerBoundInclusive)return e.lowerBoundPoints;if(e.upperBoundInclusive)return Math.min(e.upperBoundPoints,t)}modulo(e,t){return(e%t+t)%t}static \u0275fac=function(t){return new(t||a)};static \u0275prov=P({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();export{V as a};
//# sourceMappingURL=chunk-R7WDKVQG.js.map

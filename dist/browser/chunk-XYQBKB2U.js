import{a as ee}from"./chunk-A7SZQPNU.js";import{a as Z}from"./chunk-JRBFEQNN.js";import{a as $}from"./chunk-FZY4YCJJ.js";import{c as Q}from"./chunk-JNO6DNVW.js";import{b as O}from"./chunk-EELXLOHY.js";import{a as J}from"./chunk-K3W6YFKH.js";import{d as Y}from"./chunk-EDXSOKK5.js";import{p as h}from"./chunk-DID2YGL7.js";import{nb as K,sd as G,yd as X}from"./chunk-Z4VHWOB5.js";import{a as V}from"./chunk-XUCCGZJR.js";import{a as z}from"./chunk-5ZXXURLP.js";import{a as q}from"./chunk-U54OSGNH.js";import{O as H,n as B}from"./chunk-IOA4DPXY.js";import{Ad as F,Db as o,Dc as L,Ea as u,L as C,Ma as T,Mc as P,Na as A,Oc as m,Tb as D,Va as y,Z as S,Zb as x,dd as t,ed as f,f as k,fd as _,g as I,gd as W,kc as p,ra as w,rd as R,sc as v,wb as M,xc as s,ya as U,yc as r,yd as E,z as j,zc as l,zd as g}from"./chunk-5LC5EQRR.js";var N="examLastAcknowledgedEvent",b=function(n){return n.EXAM_WIDE_ANNOUNCEMENT="examWideAnnouncement",n.WORKING_TIME_UPDATE="workingTimeUpdate",n.EXAM_ATTENDANCE_CHECK="examAttendanceCheck",n.PROBLEM_STATEMENT_UPDATE="problemStatementUpdate",n}(b||{}),Ce=(()=>{class n{websocketService=u(z);examParticipationService=u($);localStorageService=u(V);httpClient=u(H);courseId;examId;studentExamId;studentExam;lastAcknowledgedEventStatus;currentWebsocketChannels;currentWebsocketReceiveSubscriptions;events=[];newUserEventSubject=new k;newSystemEventSubject=new k;allEventsSubject=new I([]);constructor(){this.clearOldAcknowledgement(),this.websocketService.connectionState.subscribe(e=>{e.connected&&e.wasEverConnectedBefore&&this.studentExamId&&setTimeout(()=>this.fetchPreviousExamEvents(),5e3)}),this.examParticipationService.currentlyLoadedStudentExam.subscribe(e=>{if(e?.id!==this.studentExamId)if(this.lastAcknowledgedEventStatus=void 0,this.unsubscribeFromExamLiveEvents(),this.events=[],e&&!e.testRun){if(this.studentExamId=e.id,this.examId=e.exam?.id,this.courseId=e.exam?.course?.id,this.studentExam=e,!this.studentExamId||!this.examId||!this.courseId)throw new Error("ExamParticipationLiveEventsService: Received invalid values for student exam id, exam id or course id");this.lastAcknowledgedEventStatus=this.getLastAcknowledgedEventOfStudentExam(),setTimeout(()=>{this.fetchPreviousExamEvents(),this.subscribeToExamLiveEvents()},5e3)}else this.allEventsSubject.next([])})}acknowledgeEvent(e,a){this.lastAcknowledgedEventStatus||(this.lastAcknowledgedEventStatus={lastChange:-1,acknowledgedEvents:{}});let i=h().unix(),c=this.lastAcknowledgedEventStatus.acknowledgedEvents[String(e.id)]||{system:0,user:0};a?c.user=i:c.system=i,this.lastAcknowledgedEventStatus.acknowledgedEvents[String(e.id)]=c,this.lastAcknowledgedEventStatus.lastChange=i,this.setEventAcknowledgeTimestamps(e),this.storeLastAcknowledgedEventsOfStudentExam()}subscribeToExamLiveEvents(){this.currentWebsocketChannels=[`/topic/exam-participation/studentExam/${this.studentExamId}/events`,`/topic/exam-participation/exam/${this.examId}/events`],this.currentWebsocketReceiveSubscriptions=this.currentWebsocketChannels.map(e=>(this.websocketService.subscribe(e),this.websocketService.receive(e).subscribe(a=>this.receiveExamLiveEvent(a))))}receiveExamLiveEvent(e){this.events.some(a=>a.id===e.id)||(e.createdDate=O(e.createdDate),e.user=this.studentExam?.user,this.events.unshift(e),this.newSystemEventSubject.next(e),this.newUserEventSubject.next(e),this.allEventsSubject.next(this.events))}unsubscribeFromExamLiveEvents(){this.currentWebsocketReceiveSubscriptions?.forEach(e=>e.unsubscribe()),this.currentWebsocketReceiveSubscriptions=void 0,this.currentWebsocketChannels?.forEach(e=>this.websocketService.unsubscribe(e)),this.currentWebsocketChannels=void 0}fetchPreviousExamEvents(){this.httpClient.get(`/api/exam/courses/${this.courseId}/exams/${this.examId}/student-exams/live-events`).subscribe(e=>{this.events=e,this.events.forEach(a=>{a.createdDate=O(a.createdDate)}),this.replayEvents(),this.allEventsSubject.next(this.events)})}replayEvents(){this.events.forEach(e=>{this.newSystemEventSubject.next(e),this.newUserEventSubject.next(e)})}storeLastAcknowledgedEventsOfStudentExam(){let e=this.loadAcknowledgedEventsMapFromLocalStorage();e[String(this.studentExamId)]=this.lastAcknowledgedEventStatus,this.localStorageService.store(N,JSON.stringify(e))}loadAcknowledgedEventsMapFromLocalStorage(){let e=this.localStorageService.retrieve(N);return e?JSON.parse(e):{}}getLastAcknowledgedEventOfStudentExam(){return this.loadAcknowledgedEventsMapFromLocalStorage()[this.studentExamId]}clearOldAcknowledgement(){let e=this.loadAcknowledgedEventsMapFromLocalStorage(),a=h().subtract(1,"day").unix();for(let i in e)e[i].lastChange<a&&delete e[i];this.localStorageService.store(N,JSON.stringify(e))}observeNewEventsAsSystem(e=[]){let a=this.newSystemEventSubject.asObservable().pipe(C(i=>!this.lastAcknowledgedEventStatus?.acknowledgedEvents[String(i.id)]?.system&&(e.length===0||e.includes(i.eventType))),w(i=>this.setEventAcknowledgeTimestamps(i)),S(i=>i.id));return setTimeout(()=>this.replayEvents()),a}observeNewEventsAsUser(e=[],a){let i=this.newUserEventSubject.asObservable().pipe(C(c=>!this.lastAcknowledgedEventStatus?.acknowledgedEvents[String(c.id)]?.user&&(e.length===0||e.includes(c.eventType))&&!(c.eventType===b.PROBLEM_STATEMENT_UPDATE&&c.createdDate.isBefore(a))),w(c=>this.setEventAcknowledgeTimestamps(c)),S(c=>c.id));return setTimeout(()=>this.replayEvents()),i}observeAllEvents(e=[]){return this.allEventsSubject.asObservable().pipe(j(a=>e.length===0?a:a.filter(i=>e.includes(i.eventType))),w(a=>a.forEach(i=>this.setEventAcknowledgeTimestamps(i))))}setEventAcknowledgeTimestamps(e){let a=this.lastAcknowledgedEventStatus?.acknowledgedEvents[String(e.id)];a&&(e.acknowledgeTimestamps={system:a.system>0?h.unix(a.system):void 0,user:a.user>0?h.unix(a.user):void 0})}static \u0275fac=function(a){return new(a||n)};static \u0275prov=U({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var ne=n=>({exerciseName:n});function ie(n,d){if(n&1&&(t(0,`
            `),s(1,"span"),t(2,"| "),l(3,"fa-icon",4),t(4),E(5,"artemisDate"),r(),t(6,`
        `)),n&2){let e=m();o(3),p("icon",e.faEye),o(),_(" ",F(5,2,e.event.acknowledgeTimestamps.user,"time"),"")}}function ae(n,d){if(n&1&&(t(0,`
                `),l(1,"div",7),E(2,"htmlForMarkdown"),t(3,`
            `)),n&2){let e=m();o(),p("innerHTML",g(2,1,e.examWideAnnouncementEvent.text),M)}}function oe(n,d){n&1&&(t(0,`
                        `),l(1,"div",9),t(2,`
                    `))}function se(n,d){n&1&&(t(0,`
                        `),l(1,"div",10),t(2,`
                    `))}function re(n,d){if(n&1&&(t(0,`
                `),s(1,"div"),t(2,`
                    `),x(3,oe,3,0)(4,se,3,0),l(5,"jhi-working-time-change",8),t(6,`
                `),r(),t(7,`
            `)),n&2){let e=m();o(3),v(e.workingTimeUpdateEvent.courseWide?3:-1),o(),v(e.workingTimeUpdateEvent.courseWide?-1:4),o(),p("oldWorkingTime",e.workingTimeUpdateEvent.oldWorkingTime)("newWorkingTime",e.workingTimeUpdateEvent.newWorkingTime)}}function le(n,d){if(n&1&&(t(0,`
                                    `),s(1,"tr"),t(2,`
                                        `),l(3,"th",16),t(4,`
                                        `),s(5,"td"),t(6),r(),t(7,`
                                    `),r(),t(8,`
                                `)),n&2){let e=m(3);o(6),f(e.event.user==null?null:e.event.user.visibleRegistrationNumber)}}function ce(n,d){if(n&1&&(t(0,`
                        `),s(1,"table",12),t(2,`
                            `),s(3,"tbody"),t(4,`
                                `),s(5,"tr"),t(6,`
                                    `),l(7,"th",13),t(8,`
                                    `),s(9,"td"),t(10),r(),t(11,`
                                `),r(),t(12,`
                                `),s(13,"tr"),t(14,`
                                    `),l(15,"th",14),t(16,`
                                    `),s(17,"td"),t(18),r(),t(19,`
                                `),r(),t(20,`
                                `),s(21,"tr"),t(22,`
                                    `),l(23,"th",15),t(24,`
                                    `),s(25,"td"),t(26),r(),t(27,`
                                `),r(),t(28,`
                                `),x(29,le,9,1),r(),t(30,`
                        `),r(),t(31,`
                    `)),n&2){let e=m(2);o(10),W("",e.event.user==null?null:e.event.user.firstName," ",e.event.user==null?null:e.event.user.lastName,""),o(8),f(e.event.user==null?null:e.event.user.login),o(8),f(e.event.user==null?null:e.event.user.email),o(3),v(e.event.user!=null&&e.event.user.visibleRegistrationNumber?29:-1)}}function me(n,d){if(n&1&&(t(0,`
                `),s(1,"div"),t(2,`
                    `),l(3,"div",11),t(4,`
                    `),x(5,ce,32,5),r(),t(6,`
            `)),n&2){let e=m();o(5),v(e.event.user?5:-1)}}function de(n,d){if(n&1&&(t(0,`
                        `),l(1,"div",18),t(2,`
                        `),l(3,"div",7),E(4,"htmlForMarkdown"),t(5,`
                    `)),n&2){let e=m(2);o(3),p("innerHTML",g(4,1,e.problemStatementUpdateEvent.text),M)}}function ve(n,d){if(n&1&&(t(0,`
                `),s(1,"div"),t(2,`
                    `),l(3,"div",17),t(4,`
                    `),x(5,de,6,3),r(),t(6,`
            `)),n&2){let e=m();o(3),p("translateValues",R(2,ne,e.problemStatementUpdateEvent.exerciseName)),o(2),v(e.problemStatementUpdateEvent.text?5:-1)}}function pe(n,d){if(n&1){let e=L();t(0,`
            `),s(1,"button",19),P("click",function(){T(e);let i=m();return A(i.acknowledgeEvent())}),t(2,`
                `),l(3,"fa-icon",4),t(4,`
                `),l(5,"span",20),t(6,`
            `),r(),t(7,`
        `)}if(n&2){let e=m();o(3),p("icon",e.faCheck)}}function xe(n,d){if(n&1){let e=L();t(0,`
            `),s(1,"button",19),P("click",function(){T(e);let i=m();return A(i.navigateToExercise())}),t(2,`
                `),l(3,"span",21),t(4,`
            `),r(),t(5,`
        `)}}var Re=(()=>{class n{event;showAcknowledge=!1;onAcknowledge=new y;onNavigate=new y;ExamLiveEventType=b;faCheck=G;faPaperPlane=X;faEye=K;get examWideAnnouncementEvent(){return this.event}get examAttendanceCheckEvent(){return this.event}get workingTimeUpdateEvent(){return this.event}get problemStatementUpdateEvent(){return this.event}acknowledgeEvent(){this.onAcknowledge.emit(this.event)}navigateToExercise(){this.onNavigate.emit(this.event)}static \u0275fac=function(a){return new(a||n)};static \u0275cmp=D({type:n,selectors:[["jhi-exam-live-event"]],inputs:{event:"event",showAcknowledge:"showAcknowledge"},outputs:{onAcknowledge:"onAcknowledge",onNavigate:"onNavigate"},decls:32,vars:12,consts:[[1,"event-wrapper",3,"ngClass"],[1,"headline"],[1,"type"],[1,"date"],[3,"icon"],[1,"content"],[1,"d-flex","gap-2"],[3,"innerHTML"],[3,"oldWorkingTime","newWorkingTime"],["jhiTranslate","artemisApp.exam.events.messages.workingTimeUpdate.titleEveryone",1,"wt-title"],["jhiTranslate","artemisApp.exam.events.messages.workingTimeUpdate.titlePersonal",1,"wt-title"],["jhiTranslate","artemisApp.exam.events.messages.examAttendanceCheck.description",1,"wt-title"],[1,"table","table-borderless","mx-auto"],["jhiTranslate","artemisApp.studentExamDetail.name"],["jhiTranslate","artemisApp.studentExamDetail.login"],["jhiTranslate","artemisApp.studentExamDetail.email"],["jhiTranslate","artemisApp.studentExamDetail.matriculationNumber"],["jhiTranslate","artemisApp.exam.events.messages.problemStatementUpdate.description",3,"translateValues"],["jhiTranslate","artemisApp.exam.events.messages.problemStatementUpdate.instructorMessage"],[1,"btn","btn-primary","w-100","mt-2",3,"click"],["jhiTranslate","artemisApp.exam.events.acknowledge"],["jhiTranslate","artemisApp.exam.events.navigateToExercise"]],template:function(a,i){if(a&1&&(s(0,"div",0),t(1,`
    `),s(2,"div",1),t(3,`
        `),s(4,"div",2),t(5),E(6,"artemisTranslate"),r(),t(7,`
    `),r(),t(8,`
    `),s(9,"div",3),t(10,`
        `),s(11,"span"),l(12,"fa-icon",4),t(13),E(14,"artemisDate"),r(),t(15,`
        `),x(16,ie,7,5),r(),t(17,`
    `),s(18,"div",5),t(19,`
        `),x(20,ae,4,3)(21,re,8,4)(22,me,7,1)(23,ve,7,4),t(24,`
    `),r(),t(25,`
    `),s(26,"div",6),t(27,`
        `),x(28,pe,8,1)(29,xe,6,0),r(),t(30,`
`),r(),t(31,`
`)),a&2){let c;p("ngClass",i.event.eventType),o(5),_(`
            `,g(6,8,"artemisApp.exam.events.type."+i.event.eventType),`
        `),o(7),p("icon",i.faPaperPlane),o(),_(" ",g(14,10,i.event.createdDate),""),o(3),v(i.event.acknowledgeTimestamps!=null&&i.event.acknowledgeTimestamps.user?16:-1),o(4),v((c=i.event.eventType)===i.ExamLiveEventType.EXAM_WIDE_ANNOUNCEMENT?20:c===i.ExamLiveEventType.WORKING_TIME_UPDATE?21:c===i.ExamLiveEventType.EXAM_ATTENDANCE_CHECK?22:c===i.ExamLiveEventType.PROBLEM_STATEMENT_UPDATE?23:-1),o(8),v(i.showAcknowledge?28:-1),o(),v(i.event.eventType===i.ExamLiveEventType.PROBLEM_STATEMENT_UPDATE?29:-1)}},dependencies:[B,q,Y,ee,Q,J,Z],styles:["[_nghost-%COMP%]{display:contents}.event-wrapper[_ngcontent-%COMP%]{display:block;border:1px solid;border-radius:3px;padding:3px 10px 10px;margin-bottom:10px;box-shadow:#00000059 0 3px 9px}.event-wrapper.examAttendanceCheck[_ngcontent-%COMP%]{background-color:var(--artemis-alert-info-background);border-color:var(--artemis-alert-info-border)}.event-wrapper.examAttendanceCheck[_ngcontent-%COMP%]   .wt-title[_ngcontent-%COMP%]{font-weight:700;font-size:1.3em;text-align:center;margin-bottom:15px}.event-wrapper.examWideAnnouncement[_ngcontent-%COMP%]{background-color:var(--artemis-alert-info-background);border-color:var(--artemis-alert-info-border)}.event-wrapper.workingTimeUpdate[_ngcontent-%COMP%]{background-color:var(--artemis-alert-warning-background);border-color:var(--artemis-alert-warning-border)}.event-wrapper.workingTimeUpdate[_ngcontent-%COMP%]   .wt-title[_ngcontent-%COMP%]{font-weight:700;font-size:1.5em;text-align:center;margin-bottom:15px}.event-wrapper.problemStatementUpdate[_ngcontent-%COMP%]{background-color:var(--artemis-alert-info-background);border-color:var(--artemis-alert-info-border)}.event-wrapper[_ngcontent-%COMP%]   .headline[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.event-wrapper[_ngcontent-%COMP%]   .headline[_ngcontent-%COMP%]   .type[_ngcontent-%COMP%]{font-weight:700;font-size:1.5em}.event-wrapper[_ngcontent-%COMP%]   .headline[_ngcontent-%COMP%]   .author[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child{font-size:.8em}.event-wrapper[_ngcontent-%COMP%]   .headline[_ngcontent-%COMP%]   .author[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:last-child{font-weight:700}.event-wrapper[_ngcontent-%COMP%]   .date[_ngcontent-%COMP%]{margin-bottom:20px;color:var(--secondary)}"]})}return n})();export{b as a,Ce as b,Re as c};
//# sourceMappingURL=chunk-XYQBKB2U.js.map

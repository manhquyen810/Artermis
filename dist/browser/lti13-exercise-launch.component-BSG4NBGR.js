import{a as k}from"./chunk-JWYCO6SY.js";import{a as v,b as I}from"./chunk-4I367PEU.js";import{b as S}from"./chunk-R5BZWVRQ.js";import"./chunk-DID2YGL7.js";import"./chunk-CXQURQM5.js";import"./chunk-S4QLGR2R.js";import"./chunk-Z4VHWOB5.js";import{b as f}from"./chunk-XUCCGZJR.js";import"./chunk-HKBU2OOC.js";import"./chunk-5ZXXURLP.js";import{a as s}from"./chunk-NOBD5HSR.js";import{a as T}from"./chunk-U54OSGNH.js";import{f as g,h as L}from"./chunk-M6Z6DKZQ.js";import"./chunk-3Y6745HG.js";import"./chunk-E2KBL4LX.js";import"./chunk-PZTBTDSR.js";import{K as d,L as p,O as m}from"./chunk-IOA4DPXY.js";import{Db as u,Ea as r,Tb as l,dd as h,kc as a,zc as c}from"./chunk-5LC5EQRR.js";import"./chunk-3E746U5Y.js";var A=(()=>{class o{route=r(g);http=r(m);accountService=r(S);router=r(L);sessionStorageService=r(f);ltiService=r(k);themeService=r(I);isLaunching;constructor(){this.isLaunching=!0}ngOnInit(){this.sendRequest()}sendRequest(){let e=this.route.snapshot.queryParamMap.get("state"),t=this.route.snapshot.queryParamMap.get("id_token");if(!e||!t){s("Required parameter for LTI launch missing"),this.isLaunching=!1;return}let i=new p().set("state",e).set("id_token",t);this.http.post("api/lti/public/lti13/auth-login",i.toString(),{headers:new d().set("Content-Type","application/x-www-form-urlencoded")}).subscribe({next:n=>{this.handleLtiLaunchSuccess(n)},error:n=>{n.status===401?this.authenticateUserThenRedirect(n):this.handleLtiLaunchError()}})}authenticateUserThenRedirect(e){let t=e.headers.get("ltiSuccessLoginRequired");this.accountService.identity().then(i=>{i?this.redirectUserToTargetLink(e):(t&&this.accountService.setPrefilledUsername(t),this.redirectUserToLoginThenTargetLink(e))})}redirectUserToTargetLink(e){let t=e.error.ltiIdToken,i=e.error.clientRegistrationId;this.storeLtiSessionData(t,i),this.replaceWindowLocationWrapper(e.error.targetLinkUri.toString())}redirectUserToLoginThenTargetLink(e){this.router.navigate(["/"]).then(()=>{this.accountService.getAuthenticationState().subscribe(t=>{t&&this.redirectUserToTargetLink(e)})})}handleLtiLaunchSuccess(e){let t=e.targetLinkUri,i=e.ltiIdToken,n=e.clientRegistrationId;window.sessionStorage.removeItem("state"),this.storeLtiSessionData(i,n),t?this.replaceWindowLocationWrapper(t):(this.isLaunching=!1,s("No LTI targetLinkUri received for a successful launch"))}handleLtiLaunchError(){window.sessionStorage.removeItem("state"),this.isLaunching=!1}storeLtiSessionData(e,t){if(!e){s(new Error("LTI ID token required to store session data."));return}if(!t){s(new Error("LTI client registration ID required to store session data."));return}try{this.sessionStorageService.store("ltiIdToken",e),this.sessionStorageService.store("clientRegistrationId",t)}catch(i){s("Failed to store session data: "+i)}}replaceWindowLocationWrapper(e){this.ltiService.setShownViaLti(!0),this.themeService.applyThemePreference(v.LIGHT);let t;e==="/lti/select-course"?t=e:t=new URL(e).pathname,this.router.navigate([t],{replaceUrl:!0})}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=l({type:o,selectors:[["jhi-lti-exercise-launch"]],decls:4,vars:2,consts:[["jhiTranslate","artemisApp.lti13.launch.launching",3,"hidden"],["jhiTranslate","artemisApp.lti13.launch.launchFailed",3,"hidden"]],template:function(t,i){t&1&&(c(0,"h1",0),h(1,`
`),c(2,"h2",1),h(3,`
`)),t&2&&(a("hidden",!i.isLaunching),u(2),a("hidden",i.isLaunching))},dependencies:[T],encapsulation:2})}return o})();export{A as Lti13ExerciseLaunchComponent};
//# sourceMappingURL=lti13-exercise-launch.component-BSG4NBGR.js.map

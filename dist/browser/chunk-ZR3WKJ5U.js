import{a as T}from"./chunk-GRLLGFUW.js";import{a as F,b as O,c as D}from"./chunk-XUG3TIT6.js";import{a as u}from"./chunk-TDPG6WFH.js";import{a as g,b as t}from"./chunk-PTO7UATL.js";import{a as M}from"./chunk-BIK4CL5A.js";import{b as A}from"./chunk-O26CMRR4.js";import{d as E}from"./chunk-AR57MWOI.js";import{Lc as b,Oc as N,e as w,tb as I,wd as C}from"./chunk-Z4VHWOB5.js";import{f as x}from"./chunk-M6Z6DKZQ.js";import{c as y}from"./chunk-E2KBL4LX.js";import{M as S}from"./chunk-IOA4DPXY.js";import{Ea as o,P as h,Tb as G,aa as l,f as B,s as p}from"./chunk-5LC5EQRR.js";import{a as d,b as v,j as c}from"./chunk-3E746U5Y.js";var n=Object.freeze({gradeName:"gradeName",lowerBoundPercentage:"lowerBoundPercentage",upperBoundPercentage:"upperBoundPercentage",isPassingGrade:"isPassingGrade"}),R=Object.freeze({bonusPoints:"bonusPoints",lowerBoundPercentage:"lowerBoundPercentage",upperBoundPercentage:"upperBoundPercentage"}),L=function(i){return i[i.POINTS=0]="POINTS",i[i.PERCENTAGE=1]="PERCENTAGE",i}(L||{}),de=(()=>{class i{gradingSystemService=o(T);route=o(x);translateService=o(y);courseService=o(E);examService=o(M);GradeType=t;ButtonSize=A;GradingScale=g;gradingScale=new g;lowerBoundInclusivity=!0;existingGradingScale=!1;firstPassingGrade;courseId;examId;isExam=!1;dialogErrorSource=new B;dialogError$=this.dialogErrorSource.asObservable();isLoading=!1;invalidGradeStepsMessage;course;exam;maxPoints;presentationsConfig={presentationType:u.NONE};faSave=I;faPlus=b;faTimes=N;faExclamationTriangle=C;faInfo=w;ngOnInit(){this.route.parent?.params.subscribe(s=>{this.isLoading=!0,this.courseId=Number(s.courseId),s.examId&&(this.examId=Number(s.examId),this.isExam=!0),this.isExam?this.handleFindObservable(this.gradingSystemService.findGradingScaleForExam(this.courseId,this.examId)):this.handleFindObservable(this.gradingSystemService.findGradingScaleForCourse(this.courseId))})}handleFindObservable(s){s.pipe(l(()=>{this.isLoading=!1})).subscribe(e=>{e.body&&this.handleFindResponse(e.body),this.isExam?this.examService.find(this.courseId,this.examId).subscribe(r=>{this.exam=r.body,this.maxPoints=this.exam?.examMaxPoints,this.onChangeMaxPoints(this.exam?.examMaxPoints)}):this.courseService.find(this.courseId).subscribe(r=>{this.course=r.body,this.gradingScale.course=this.course,this.maxPoints=this.course?.maxPoints,this.onChangeMaxPoints(this.course?.maxPoints)})})}handleFindResponse(s){s&&(s.gradeSteps=this.gradingSystemService.sortGradeSteps(s.gradeSteps),this.gradingScale=s,this.existingGradingScale=!0,this.setBoundInclusivity(),this.determineFirstPassingGrade())}save(){this.isLoading=!0,this.gradingScale.gradeSteps=this.gradingSystemService.sortGradeSteps(this.gradingScale.gradeSteps),this.setInclusivity(),this.gradingScale.gradeSteps=this.setPassingGrades(this.gradingScale.gradeSteps),this.gradingScale.gradeSteps.forEach(s=>{s.id=void 0}),this.isExam?(this.gradingScale.exam=this.exam,this.gradingScale.exam.examMaxPoints=this.maxPoints):(this.gradingScale.course=this.course,this.gradingScale.course.maxPoints=this.maxPoints,this.gradingScale.course.presentationScore=this.presentationsConfig.presentationScore),this.existingGradingScale?this.isExam?this.handleSaveObservable(this.gradingSystemService.updateGradingScaleForExam(this.courseId,this.examId,this.gradingScale)):this.handleSaveObservable(this.gradingSystemService.updateGradingScaleForCourse(this.courseId,this.gradingScale)):this.isExam?this.handleSaveObservable(this.gradingSystemService.createGradingScaleForExam(this.courseId,this.examId,this.gradingScale)):this.handleSaveObservable(this.gradingSystemService.createGradingScaleForCourse(this.courseId,this.gradingScale))}validGradeSteps(){if(!this.gradingScale||this.gradingScale.gradeSteps.length===0)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.empty"),!1;if(this.maxPoints!=null&&this.maxPoints<0)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.negativeMaxPoints"),!1;for(let e of this.gradingScale.gradeSteps){if(e.gradeName===""||e.gradeName===null||e.lowerBoundPercentage===null||e.upperBoundPercentage===null)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.emptyFields"),!1;if(this.maxPointsValid()&&(e.lowerBoundPoints==null||e.upperBoundPoints==null))return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.emptyFields"),!1}for(let e of this.gradingScale.gradeSteps)if(e.lowerBoundPercentage<0||e.lowerBoundPercentage>=e.upperBoundPercentage)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidMinMaxPercentages"),!1;if(this.maxPointsValid()){for(let e of this.gradingScale.gradeSteps)if(e.lowerBoundPoints<0||e.lowerBoundPoints>=e.upperBoundPoints)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidMinMaxPoints"),!1}else for(let e of this.gradingScale.gradeSteps)if(e.lowerBoundPoints!=null||e.upperBoundPoints!=null)return!1;if(this.gradingScale.gradeType===t.GRADE){if(!this.gradingScale.gradeSteps.map(e=>e.gradeName).every((e,r,a)=>a.indexOf(e)===r))return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.nonUniqueGradeNames"),!1;if(this.firstPassingGrade===void 0||this.firstPassingGrade==="")return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.unsetFirstPassingGrade"),!1}let s=[];if(this.gradingScale.gradeSteps.forEach(e=>s.push(Object.assign({},e))),s=this.gradingSystemService.sortGradeSteps(s),this.gradingScale.gradeType===t.BONUS){for(let e of s)if(isNaN(Number(e.gradeName))||Number(e.gradeName)<0)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidBonusPoints"),!1;if(!s.map(e=>Number(e.gradeName)).every((e,r,a)=>r===0||e>a[r-1]))return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.nonStrictlyIncreasingBonusPoints"),!1}for(let e=0;e<s.length-1;e++)if(s[e].upperBoundPercentage!==s[e+1].lowerBoundPercentage)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidAdjacency"),!1;return s[0].lowerBoundPercentage!==0||s.last().upperBoundPercentage<100?(this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidFirstAndLastStep"),!1):(this.invalidGradeStepsMessage=void 0,!0)}validPresentationsConfig(){if(this.presentationsConfig.presentationType===u.NONE&&(this.presentationsConfig.presentationsNumber!==void 0||this.presentationsConfig.presentationsWeight!==void 0||this.presentationsConfig.presentationScore!==void 0))return!1;if(this.presentationsConfig.presentationType===u.BASIC){if(this.presentationsConfig.presentationsNumber!==void 0||this.presentationsConfig.presentationsWeight!==void 0)return!1;if((this.course?.presentationScore??0)<=0)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidPresentationsNumber"),!1}if(this.presentationsConfig.presentationType===u.GRADED){if(this.presentationsConfig.presentationsNumber===void 0||!Number.isInteger(this.presentationsConfig.presentationsNumber)||this.presentationsConfig.presentationsNumber<1)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidPresentationsNumber"),!1;if(this.presentationsConfig.presentationsWeight===void 0||this.presentationsConfig.presentationsWeight<0||this.presentationsConfig.presentationsWeight>99)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidPresentationsWeight"),!1;if((this.course?.presentationScore??0)>0)return this.invalidGradeStepsMessage=this.translateService.instant("artemisApp.gradingSystem.error.invalidBasicPresentationIsEnabled"),!1}return this.invalidGradeStepsMessage=void 0,!0}handleSaveObservable(s){s.pipe(l(()=>{this.isLoading=!1}),h(()=>p(new S({status:400})))).subscribe(e=>{this.handleSaveResponse(e.body)})}handleSaveResponse(s){s&&(s.gradeSteps=this.gradingSystemService.sortGradeSteps(s.gradeSteps),this.existingGradingScale=!0)}maxPointsValid(){return this.maxPoints!=null&&this.maxPoints>0}setPercentage(s,e){e?s.lowerBoundPercentage=s.lowerBoundPoints/this.maxPoints*100:s.upperBoundPercentage=s.upperBoundPoints/this.maxPoints*100}setPoints(s,e){if(this.maxPoints)e?s.lowerBoundPoints=this.maxPoints*s.lowerBoundPercentage/100:s.upperBoundPoints=this.maxPoints*s.upperBoundPercentage/100;else return}onChangeMaxPoints(s){if(s==null||s<0)for(let e of this.gradingScale.gradeSteps)e.lowerBoundPoints=void 0,e.upperBoundPoints=void 0;else for(let e of this.gradingScale.gradeSteps)this.setPoints(e,!0),this.setPoints(e,!1)}delete(){this.existingGradingScale&&(this.isLoading=!0,this.isExam?this.handleDeleteObservable(this.gradingSystemService.deleteGradingScaleForExam(this.courseId,this.examId)):this.handleDeleteObservable(this.gradingSystemService.deleteGradingScaleForCourse(this.courseId)),this.gradingScale=new g,this.gradingScale.course=this.course)}handleDeleteObservable(s){s.pipe(h(()=>p(new S({status:400}))),l(()=>{this.isLoading=!1})).subscribe(()=>{this.existingGradingScale=!1,this.dialogErrorSource.next("")})}setBoundInclusivity(){let s=this.gradingScale.gradeSteps.last()?.id;this.lowerBoundInclusivity=this.gradingScale.gradeSteps.every(e=>e.id===s?!0:e.lowerBoundInclusive||e.lowerBoundPercentage===0)}determineFirstPassingGrade(){this.firstPassingGrade=this.gradingScale.gradeSteps.find(s=>s.isPassingGrade)?.gradeName}setPassingGrades(s){let e=!1;return s.forEach(r=>{r.gradeName===this.firstPassingGrade&&(e=!0),r.isPassingGrade=e}),s}deleteGradeNames(){this.gradingScale.gradeSteps.forEach(s=>{s.gradeName=""})}gradeStepsWithNonemptyNames(){return this.gradingScale.gradeSteps?this.gradingScale.gradeSteps.filter(s=>s.gradeName!==""):[]}createGradeStep(){this.gradingScale||(this.gradingScale=new g),this.gradingScale.gradeSteps||(this.gradingScale.gradeSteps=[]);let r={gradeName:"",lowerBoundPercentage:this.gradingScale.gradeSteps.length===0?0:this.gradingScale.gradeSteps.last().upperBoundPercentage,upperBoundPercentage:100,isPassingGrade:!0,lowerBoundInclusive:this.lowerBoundInclusivity,upperBoundInclusive:!this.lowerBoundInclusivity};this.setPoints(r,!0),this.setPoints(r,!1),this.gradingScale.gradeSteps.push(r)}deleteGradeStep(s){this.gradingScale.gradeSteps.splice(s,1)}generateDefaultGradingScale(){this.gradingScale=this.getDefaultGradingScale(),this.firstPassingGrade=this.gradingScale.gradeSteps[3].gradeName,this.lowerBoundInclusivity=!0}getDefaultGradingScale(){let m=[{gradeName:"5.0",lowerBoundPercentage:0,upperBoundPercentage:40,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!1},{gradeName:"4.7",lowerBoundPercentage:40,upperBoundPercentage:45,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!1},{gradeName:"4.3",lowerBoundPercentage:45,upperBoundPercentage:50,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!1},{gradeName:"4.0",lowerBoundPercentage:50,upperBoundPercentage:55,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"3.7",lowerBoundPercentage:55,upperBoundPercentage:60,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"3.3",lowerBoundPercentage:60,upperBoundPercentage:65,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"3.0",lowerBoundPercentage:65,upperBoundPercentage:70,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"2.7",lowerBoundPercentage:70,upperBoundPercentage:75,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"2.3",lowerBoundPercentage:75,upperBoundPercentage:80,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"2.0",lowerBoundPercentage:80,upperBoundPercentage:85,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"1.7",lowerBoundPercentage:85,upperBoundPercentage:90,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"1.3",lowerBoundPercentage:90,upperBoundPercentage:95,lowerBoundInclusive:!0,upperBoundInclusive:!1,isPassingGrade:!0},{gradeName:"1.0",lowerBoundPercentage:95,upperBoundPercentage:100,lowerBoundInclusive:!0,upperBoundInclusive:!0,isPassingGrade:!0}];for(let P of m)this.setPoints(P,!0),this.setPoints(P,!1);return{gradeSteps:m,gradeType:t.GRADE,course:this.course}}onCSVFileSelect(s){return c(this,null,function*(){s.target.files.length>0&&(yield this.readGradingStepsFromCSVFile(s.target.files[0]),this.lowerBoundInclusivity=!0,this.setInclusivity(),this.maxPoints=100,this.onChangeMaxPoints(this.maxPoints),this.determineFirstPassingGrade(),this.gradingScale.gradeSteps.sort((e,r)=>e.lowerBoundPercentage-r.lowerBoundPercentage))})}readGradingStepsFromCSVFile(s){return c(this,null,function*(){let e=[];try{e=yield this.parseCSVFile(s)}catch{return[]}if(e.length===0||e.length>100){this.gradingScale.gradeSteps=[];return}let r=e[0].bonusPoints===void 0?t.GRADE:t.BONUS;r===t.BONUS?this.gradingScale.gradeType=t.BONUS:this.gradingScale.gradeType=t.GRADE,this.gradingScale.gradeSteps=this.mapCsvGradeStepsToGradeSteps(e,r)})}mapCsvGradeStepsToGradeSteps(s,e){return s.map(r=>d({gradeName:e===t.GRADE?String(r[n.gradeName]??""):String(r[R.bonusPoints]??""),lowerBoundPercentage:r[n.lowerBoundPercentage]?Number(r[n.lowerBoundPercentage]):void 0,upperBoundPercentage:r[n.upperBoundPercentage]?Number(r[n.upperBoundPercentage]):void 0},e===t.GRADE&&{isPassingGrade:r[n.isPassingGrade]==="TRUE"}))}exportGradingStepsToCsv(){let s=this.gradingScale.gradeType===t.GRADE?Object.keys(n):Object.keys(R),e=this.gradingScale.gradeSteps.map(r=>this.convertToCsvRow(r));this.exportAsCSV(e,s)}convertToCsvRow(s){return d(v(d(d({},this.gradingScale.gradeType===t.GRADE&&{gradeName:s.gradeName??""}),this.gradingScale.gradeType===t.BONUS&&{bonusPoints:s.gradeName??""}),{lowerBoundPercentage:s.lowerBoundPercentage??"",upperBoundPercentage:s.upperBoundPercentage??""}),this.gradingScale.gradeType===t.GRADE&&{isPassingGrade:s.isPassingGrade})}exportAsCSV(s,e){let r={fieldSeparator:",",quoteStrings:!1,decimalSeparator:"locale",showLabels:!0,filename:"grading_key"+(this.gradingScale.course?.shortName?"_"+this.gradingScale.course?.shortName:""),useTextFile:!1,useBom:!0,columnHeaders:e},a=F(r),f=O(a)(s);D(a)(f)}isAnyGradingStepAboveMaxPoints(s){for(let e of s)if(e.upperBoundInclusive&&e.upperBoundPercentage>100||!e.upperBoundInclusive&&e.upperBoundPercentage>=100)return!0;return!1}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=G({type:i,selectors:[["ng-component"]],decls:0,vars:0,template:function(e,r){},encapsulation:2})}return i})();export{L as a,de as b};
//# sourceMappingURL=chunk-ZR3WKJ5U.js.map

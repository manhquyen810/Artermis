import{e as m}from"./chunk-CK7FH6VF.js";import{e as v}from"./chunk-5GXY5RYT.js";import{p as a}from"./chunk-DID2YGL7.js";import{c as S}from"./chunk-CXQURQM5.js";import{a as P}from"./chunk-5ZXXURLP.js";import{Ea as b,b as h,g as o,oa as f,ra as p,s as n,ya as d}from"./chunk-5LC5EQRR.js";import{a as u,b as l}from"./chunk-3E746U5Y.js";var w="/user/topic/newResults",g=r=>`/topic/exercise/${r}/newResults`,N=(()=>{class r{websocketService=b(P);participationService=b(m);cachedParticipations=new Map;openResultWebsocketSubscriptions=new Map;openPersonalWebsocketSubscription;resultObservables=new Map;participationObservable;subscribedExercises=new Map;participationSubscriptionTypes=new Map;getNotifyAllSubscribersPipe=()=>h(p(this.notifyResultSubscribers),f(this.addResultToParticipation),p(this.notifyParticipationSubscribers));resetLocalCache(){this.getAllParticipations().forEach(i=>{this.cachedParticipations.delete(i.id),this.removeParticipation(i.id,i.exercise?.id)}),this.cachedParticipations=new Map,this.resultObservables=new Map,this.participationObservable=void 0,this.subscribedExercises=new Map,this.participationSubscriptionTypes=new Map}notifyParticipationSubscribers=e=>{this.participationObservable?this.participationObservable.next(e):this.participationObservable=new o(e)};notifyResultSubscribers=e=>{let i=this.resultObservables.get(e.participation.id);i?i.next(e):this.resultObservables.set(e.participation.id,new o(e))};addResultToParticipation=e=>{let i=this.cachedParticipations.get(e.participation.id);if(i){let t=[...i.results||[]].filter(s=>s.id!==e.id);return t.push(e),this.cachedParticipations.set(e.participation.id,l(u({},i),{results:t})),n(this.cachedParticipations.get(e.participation.id))}return n()};addParticipation=(e,i)=>{let t=v(e);if(!t.exercise&&!i)throw new Error("a link from the participation to the exercise is required. Please attach it manually or add exercise as function input");t.exercise=t.exercise||i,this.cachedParticipations.set(t.id,t),this.notifyParticipationSubscribers(t)};getAllParticipations(){return[...this.cachedParticipations.values()]}getParticipationsForExercise(e){let i=[...this.cachedParticipations.values()].filter(t=>t.exercise?.id===e);return i?.length?this.participationService.mergeStudentParticipations(i):[]}removeParticipation(e,i){let t=this.participationSubscriptionTypes.get(e);if(this.participationSubscriptionTypes.delete(e),t!=null)if(t)[...this.participationSubscriptionTypes.values()].filter(c=>c).length===0&&(this.websocketService.unsubscribe(w),this.openPersonalWebsocketSubscription=void 0);else{let s=this.subscribedExercises.get(i);if(s&&(s.delete(e),s.size===0)){this.subscribedExercises.delete(i);let c=this.openResultWebsocketSubscriptions.get(i);c&&(this.websocketService.unsubscribe(c),this.openResultWebsocketSubscriptions.delete(i))}}}openResultWebsocketSubscriptionIfNotExisting(e,i,t){if(i&&!this.openPersonalWebsocketSubscription||!i&&!this.openResultWebsocketSubscriptions.has(t)){let s;i?(s=w,this.openPersonalWebsocketSubscription=s):(s=g(t),this.openResultWebsocketSubscriptions.set(t,s)),this.participationSubscriptionTypes.set(e,i),this.subscribedExercises.has(t)||this.subscribedExercises.set(t,new Set),this.subscribedExercises.get(t).add(e),this.websocketService.subscribe(s),this.websocketService.receive(s).pipe(this.getNotifyAllSubscribersPipe()).subscribe()}}notifyAllResultSubscribers=e=>{n(e).pipe(this.getNotifyAllSubscribersPipe()).subscribe()};subscribeForParticipationChanges(){return this.participationObservable||(this.participationObservable=new o(void 0)),this.participationObservable}subscribeForLatestResultOfParticipation(e,i,t){this.openResultWebsocketSubscriptionIfNotExisting(e,i,t);let s=this.resultObservables.get(e);return s||(s=new o(void 0),this.resultObservables.set(e,s)),s}unsubscribeForLatestResultOfParticipation(e,i){let t=!1;if(i.type===S.PROGRAMMING){let s=i;t=!!s.buildAndTestStudentSubmissionsAfterDueDate&&a(s.buildAndTestStudentSubmissionsAfterDueDate).isBefore(a())}(t||i.dueDate&&a(i.dueDate).isBefore(a()))&&this.removeParticipation(e,i.id)}static \u0275fac=function(i){return new(i||r)};static \u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();export{N as a};
//# sourceMappingURL=chunk-JHBUBEY6.js.map

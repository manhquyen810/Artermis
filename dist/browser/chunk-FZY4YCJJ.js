import{c as j}from"./chunk-CK7FH6VF.js";import{b as C}from"./chunk-PUNMJFMR.js";import{e as p}from"./chunk-5GXY5RYT.js";import{p as a}from"./chunk-DID2YGL7.js";import{c as L,h as w}from"./chunk-CXQURQM5.js";import{E as R}from"./chunk-Z4VHWOB5.js";import{a as F,b as D}from"./chunk-XUCCGZJR.js";import{a as E}from"./chunk-NOBD5HSR.js";import{L as v,O as y}from"./chunk-IOA4DPXY.js";import{Ea as S,P as l,f as h,g as d,ra as g,s as m,t as c,ya as x,z as u}from"./chunk-5LC5EQRR.js";import{a as f,b}from"./chunk-3E746U5Y.js";var M=(()=>{class o{httpClient=S(y);localStorageService=S(F);sessionStorage=S(D);currentlyLoadedStudentExam=new h;examIsStartedSubject=new d(!1);examIsStarted$=this.examIsStartedSubject.asObservable();testRunSubject=new d(!1);testRunStarted$=this.testRunSubject.asObservable();examEndViewSubject=new d(!1);endViewDisplayed$=this.examEndViewSubject.asObservable();getResourceURL(e,t){return`api/exam/courses/${e}/exams/${t}`}static getLocalStorageKeyForStudentExam(e,t){return`artemis_student_exam_${e}_${t}`}loadStudentExamWithExercisesForConduction(e,t,s){let r=this.getResourceURL(e,t)+"/student-exams/"+s+"/conduction";return this.getStudentExamFromServer(r,e,t)}loadStudentExamWithExercisesForConductionFromLocalStorage(e,t){let s=JSON.parse(this.localStorageService.retrieve(o.getLocalStorageKeyForStudentExam(e,t)));return m(s)}loadStudentExamWithExercisesForSummary(e,t,s){let r=this.getResourceURL(e,t)+"/student-exams/"+s+"/summary";return this.getStudentExamFromServer(r,e,t)}getStudentExamFromServer(e,t,s){return this.httpClient.get(e).pipe(u(r=>(r.examSessions&&r.examSessions.length>0&&r.examSessions[0].sessionToken&&this.saveExamSessionTokenToSessionStorage(r.examSessions[0].sessionToken),o.convertStudentExamFromServer(r))),g(r=>{this.currentlyLoadedStudentExam.next(r)}),l(()=>{let r=JSON.parse(this.localStorageService.retrieve(o.getLocalStorageKeyForStudentExam(t,s)));return m(r)}))}loadStudentExamGradeInfoForSummary(e,t,s,r){let n=new v;r&&(n=n.set("userId",r.toString()));let i=`${this.getResourceURL(e,t)}/student-exams/${s}/grade-summary`;return this.httpClient.get(i,{params:n})}getOwnStudentExam(e,t){let s=this.getResourceURL(e,t)+"/own-student-exam";return this.httpClient.get(s).pipe(u(r=>{let n=o.convertStudentExamDateFromServer(r);return this.currentlyLoadedStudentExam.next(n),n}))}loadTestRunWithExercisesForConduction(e,t,s){let r=this.getResourceURL(e,t)+"/test-run/"+s+"/conduction";return this.httpClient.get(r).pipe(u(n=>{let i=o.convertStudentExamDateFromServer(n);return this.currentlyLoadedStudentExam.next(i),i}))}loadStudentExamsForTestExamsPerCourseAndPerUserForOverviewPage(e){let t=`api/exam/courses/${e}/test-exams-per-user`;return this.httpClient.get(t,{observe:"response"}).pipe(u(s=>this.processListOfStudentExamsFromServer(s)))}processListOfStudentExamsFromServer(e){return e.body.forEach(t=>o.convertStudentExamDateFromServer(t)),e.body}submitStudentExam(e,t,s){let r=this.getResourceURL(e,t)+"/student-exams/submit",n=p(s);return o.breakCircularDependency(n),this.httpClient.post(r,n).pipe(l(i=>i.status===403&&i.headers.get("x-null-error")==="error.submissionNotInTime"?c(()=>new Error("artemisApp.studentExam.submissionNotInTime")):i.status===409&&i.headers.get("x-null-error")==="error.alreadySubmitted"?c(()=>new Error("artemisApp.studentExam.alreadySubmitted")):c(()=>new Error("artemisApp.studentExam.handInFailed"))))}static breakCircularDependency(e){e.exercises.forEach(t=>{if(t.studentParticipations)for(let s of t.studentParticipations){if(s.results){for(let r of s.results)if(delete r.participation,r.feedbacks)for(let n of r.feedbacks)delete n.result}if(s.submissions)for(let r of s.submissions){delete r.participation;let n=C(r);n&&(delete n.participation,delete n.submission)}delete s.exercise}})}saveStudentExamToLocalStorage(e,t,s){try{let r=p(s);o.breakCircularDependency(r),this.localStorageService.store(o.getLocalStorageKeyForStudentExam(e,t),JSON.stringify(r))}catch(r){E(r)}}saveExamSessionTokenToSessionStorage(e){this.sessionStorage.store("ExamSessionToken",e)}updateQuizSubmission(e,t){let s=`api/quiz/exercises/${e}/submissions/exam`;return this.httpClient.put(s,t)}setLastSaveFailed(e,t,s){let r=o.getLocalStorageKeyForStudentExam(t,s)+"-save-failed";this.localStorageService.store(r,e)}lastSaveFailed(e,t){let s=o.getLocalStorageKeyForStudentExam(e,t)+"-save-failed";return this.localStorageService.retrieve(s)}static convertStudentExamFromServer(e){return e.exercises=j.convertExercisesDateFromServer(e.exercises),e.exam=o.convertExamDateFromServer(e.exam),e.exercises=e.exercises.map(t=>(t.exerciseGroup=b(f({},t.exerciseGroup),{exam:e.exam}),t)),e}static convertExamDateFromServer(e){return e&&(e.visibleDate=e.visibleDate?a(e.visibleDate):void 0,e.startDate=e.startDate?a(e.startDate):void 0,e.endDate=e.endDate?a(e.endDate):void 0,e.publishResultsDate=e.publishResultsDate?a(e.publishResultsDate):void 0,e.examStudentReviewStart=e.examStudentReviewStart?a(e.examStudentReviewStart):void 0,e.examStudentReviewEnd=e.examStudentReviewEnd?a(e.examStudentReviewEnd):void 0),e}static convertStudentExamDateFromServer(e){return e.exam=o.convertExamDateFromServer(e.exam),e.submissionDate=e.submissionDate&&a(e.submissionDate),e.startedDate=e.startedDate&&a(e.startedDate),e}static getSubmissionForExercise(e){let t=o.getParticipationForExercise(e);if(t&&t.submissions)return t.submissions.last()}static getParticipationForExercise(e){if(e&&e.studentParticipations&&e.studentParticipations.length>0)return e.studentParticipations[0]}getExerciseButtonTooltip(e){let t=o.getSubmissionForExercise(e);return t?e.type!==L.PROGRAMMING?t.submitted?t.isSynced?"synced":"notSynced":t.isSynced?"notStarted":"notSynced":t.submitted&&t.isSynced?"submitted":!t.submitted&&t.isSynced?"notSubmitted":"notSavedOrSubmitted":"synced"}setEndView(e){this.examEndViewSubject.next(e)}setExamLayout(e=!0,t=!1){this.examIsStartedSubject.next(e),this.testRunSubject.next(t)}resetExamLayout(){this.examIsStartedSubject.next(!1),this.testRunSubject.next(!1),document.documentElement.style.setProperty("--header-height","68px")}mapExercisesToSidebarCardElements(e){return e.map(t=>this.mapExerciseToSidebarCardElement(t))}mapExerciseToSidebarCardElement(e){return{title:e.exerciseGroup?.title??"",id:e.id??"",icon:w(e.type),rightIcon:R,size:"M"}}static \u0275fac=function(t){return new(t||o)};static \u0275prov=x({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();export{M as a};
//# sourceMappingURL=chunk-FZY4YCJJ.js.map
